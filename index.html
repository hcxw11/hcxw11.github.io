<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN,default">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="前端/js/react/vue">
<meta property="og:type" content="website">
<meta property="og:title" content="吴某某嗯">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="吴某某嗯">
<meta property="og:description" content="前端/js/react/vue">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="吴某某嗯">
<meta name="twitter:description" content="前端/js/react/vue">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>吴某某嗯</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">吴某某嗯</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/12/技术栈/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxc">
      <meta itemprop="description" content="前端/js/react/vue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴某某嗯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/12/技术栈/" itemprop="url">
                  技术栈
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-07-12 22:26:13" itemprop="dateCreated datePublished" datetime="2018-07-12T22:26:13+08:00">2018-07-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-13 00:40:22" itemprop="dateModified" datetime="2018-07-13T00:40:22+08:00">2018-07-13</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="整理下-18-年-7-月为止使用过的技术栈"><a href="#整理下-18-年-7-月为止使用过的技术栈" class="headerlink" title="整理下 18 年 7 月为止使用过的技术栈"></a>整理下 18 年 7 月为止使用过的技术栈</h3><p>前端框架：vue react</p>
<p>全局状态容器：redux redux-saga vuex</p>
<p>路由：react-router vue-router</p>
<p>组件库：vux ant-design element mint-ui</p>
<p>http 请求：axios fetch</p>
<p>图表工具： echarts highcharts g2(bizcharts)</p>
<p>地图：高德地图 百度地图</p>
<p>构建工具：webpack</p>
<p>包管理：npm yarn</p>
<p>脚手架： vue-cli dva-cli create-react-app ant-design-pro</p>
<p>动效库：ant-motion sprite.js</p>
<p>工具库：lodash</p>
<p>协同工作：git</p>
<p>编码规范：airbnb</p>
<p>语法校验：eslint</p>
<p>代码整理：eslint prettier</p>
<p>node 框架：egg</p>
<p>数据库：mongodb</p>
<p>样式：less</p>
<p>其他：微信小游戏 react-native</p>
<p>部署：nginx</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/11/ant-design-pro中的router使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxc">
      <meta itemprop="description" content="前端/js/react/vue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴某某嗯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/11/ant-design-pro中的router使用/" itemprop="url">
                  ant design pro中的router使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-07-11 21:19:39" itemprop="dateCreated datePublished" datetime="2018-07-11T21:19:39+08:00">2018-07-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-12 23:05:57" itemprop="dateModified" datetime="2018-07-12T23:05:57+08:00">2018-07-12</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="react-router"><a href="#react-router" class="headerlink" title="react-router"></a>react-router</h2><p>dva 中虽然对 router 做了简单的封装，使用的是<a href="https://github.com/ReactTraining/react-router" target="_blank" rel="noopener">react-router</a>这个库(<a href="https://reacttraining.com/react-router/web/example/basic" target="_blank" rel="noopener">react-router 文档</a>)</p>
<p>下面是一个简单的 react-router 例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">import React from &quot;react&quot;;</span><br><span class="line">import &#123; BrowserRouter as Router, Route, Link &#125; from &quot;react-router-dom&quot;;</span><br><span class="line"></span><br><span class="line">const BasicExample = () =&gt; (</span><br><span class="line">  &lt;Router&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &lt;li&gt;</span><br><span class="line">          &lt;Link to=&quot;/&quot;&gt;Home&lt;/Link&gt;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line">        &lt;li&gt;</span><br><span class="line">          &lt;Link to=&quot;/about&quot;&gt;About&lt;/Link&gt;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line">        &lt;li&gt;</span><br><span class="line">          &lt;Link to=&quot;/topics&quot;&gt;Topics&lt;/Link&gt;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">      &lt;hr /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;Route exact path=&quot;/&quot; component=&#123;Home&#125; /&gt;</span><br><span class="line">      &lt;Route path=&quot;/about&quot; component=&#123;About&#125; /&gt;</span><br><span class="line">      &lt;Route path=&quot;/topics&quot; component=&#123;Topics&#125; /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/Router&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">const Home = () =&gt; (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h2&gt;Home&lt;/h2&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">const About = () =&gt; (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h2&gt;About&lt;/h2&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">const Topics = (&#123; match &#125;) =&gt; (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h2&gt;Topics&lt;/h2&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">      &lt;li&gt;</span><br><span class="line">        &lt;Link to=&#123;`$&#123;match.url&#125;/rendering`&#125;&gt;Rendering with React&lt;/Link&gt;</span><br><span class="line">      &lt;/li&gt;</span><br><span class="line">      &lt;li&gt;</span><br><span class="line">        &lt;Link to=&#123;`$&#123;match.url&#125;/components`&#125;&gt;Components&lt;/Link&gt;</span><br><span class="line">      &lt;/li&gt;</span><br><span class="line">      &lt;li&gt;</span><br><span class="line">        &lt;Link to=&#123;`$&#123;match.url&#125;/props-v-state`&#125;&gt;Props v. State&lt;/Link&gt;</span><br><span class="line">      &lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Route path=&#123;`$&#123;match.url&#125;/:topicId`&#125; component=&#123;Topic&#125; /&gt;</span><br><span class="line">    &lt;Route</span><br><span class="line">      exact</span><br><span class="line">      path=&#123;match.url&#125;</span><br><span class="line">      render=&#123;() =&gt; &lt;h3&gt;Please select a topic.&lt;/h3&gt;&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">const Topic = (&#123; match &#125;) =&gt; (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h3&gt;&#123;match.params.topicId&#125;&lt;/h3&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">export default BasicExample;</span><br></pre></td></tr></table></figure>
<p>上面的例子中，可以看出一个路由节点主要使用<code>Route</code>，由 path 和组件(render 或 component)组成，导航栏则是使用<code>Link</code>，在 dva 也是类似如此，只是这里的<code>Route</code>和<code>Link</code>是根据配置动态生成的。</p>
<h2 id="一个大致的流程"><a href="#一个大致的流程" class="headerlink" title="一个大致的流程"></a>一个大致的流程</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>在<code>src/common/menu.js</code>配置里导航栏，在<code>src/common/router.js</code>中配置了 path 和组件的关系，如下图：<img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-7-11/88394112.jpg" alt=""></p>
<h3 id="外层路由配置"><a href="#外层路由配置" class="headerlink" title="外层路由配置"></a>外层路由配置</h3><p>在<code>src/router.js</code>中，配置了最外层的路由。这里主要是用于控制页面进入后台管理系统还是进入登陆页面。ant design pro 中生成框架时定义<code>/user/*</code>相关的路由是用于用户登录等操作，其他操作则是<code>/*</code>路径，从下面的配置中可以看出，如果匹配到了<code>/user/*</code>的路径会使用<code>UserLayout</code>组件，而其他页面会使用<code>BasicLayout</code>组件（<code>AuthorizedRoute</code>组件还用于判断权限，如果没有权限则跳转到<code>/user/login</code>，即登陆页面）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;Switch&gt;</span><br><span class="line">  &lt;Route path=&quot;/user&quot; component=&#123;UserLayout&#125; /&gt;</span><br><span class="line">  &lt;AuthorizedRoute</span><br><span class="line">    path=&quot;/screen&quot;</span><br><span class="line">    render=&#123;props =&gt; &lt;ScreenLayout &#123;...props&#125; /&gt;&#125;</span><br><span class="line">    authority=&#123;[&apos;admin&apos;]&#125;</span><br><span class="line">    redirectPath=&quot;/user/login&quot;</span><br><span class="line">  /&gt;</span><br><span class="line">  &lt;AuthorizedRoute</span><br><span class="line">    path=&quot;/&quot;</span><br><span class="line">    render=&#123;props =&gt; &lt;BasicLayout &#123;...props&#125; /&gt;&#125;</span><br><span class="line">    authority=&#123;[&apos;admin&apos;]&#125;</span><br><span class="line">    redirectPath=&quot;/user/login&quot;</span><br><span class="line">  /&gt;</span><br><span class="line">&lt;/Switch&gt;</span><br></pre></td></tr></table></figure>
<h3 id="里层路由配置"><a href="#里层路由配置" class="headerlink" title="里层路由配置"></a>里层路由配置</h3><p>在<code>src/layouts/BasicLayout.js</code>中，配置了系统里层的路由配置。这里使用的是 antd 的<a href="http://ant-design.gitee.io/components/layout-cn/" target="_blank" rel="noopener">Layout</a>组件，对系统的导航栏，Header，Footer 做了全局的配置，以及对应路由内容的显示，一般结构如下：</p>
<p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-7-11/38172382.jpg" alt=""></p>
<p>这里的难点主要是如何根据上面配置动态生成导航栏和显示对应的内容。</p>
<h3 id="内容显示"><a href="#内容显示" class="headerlink" title="内容显示"></a>内容显示</h3><ol>
<li><p>重定向到子页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;redirectData.map(item =&gt; (</span><br><span class="line">	&lt;Redirect key=&#123;item.from&#125; exact from=&#123;item.from&#125; to=&#123;item.to&#125; /&gt;</span><br><span class="line">))&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码的作用是，比如系统管理的路径<code>/system</code>，下面第一个页面是账户管理路径<code>/system/systemUser</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    name: &apos;系统管理&apos;,</span><br><span class="line">    icon: &apos;system&apos;,</span><br><span class="line">    path: &apos;system&apos;,</span><br><span class="line">    children: [&#123;</span><br><span class="line">      name: &apos;账户管理&apos;,</span><br><span class="line">      path: &apos;systemUser&apos;,</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果访问<code>/system</code>，会自动重定向到<code>/system/systemUser</code>（因为<code>/system</code>是没有页面的）</p>
</li>
<li><p>显示当前的路由的页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;getRoutes(match.path, routerData).map(item =&gt; (</span><br><span class="line">  &lt;AuthorizedRoute</span><br><span class="line">    key=&#123;item.key&#125;</span><br><span class="line">    path=&#123;item.path&#125;</span><br><span class="line">    component=&#123;item.component&#125;</span><br><span class="line">    exact=&#123;item.exact&#125;</span><br><span class="line">    authority=&#123;item.authority&#125;</span><br><span class="line">    redirectPath=&quot;/exception/403&quot;</span><br><span class="line">    /&gt;</span><br><span class="line">))&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// src/components/Authorized/AuthorizedRoute.js</span><br><span class="line">// 根据权限规则判断，如果有权限则正常访问页面，否则就访问redirectPath，即/exception/403</span><br><span class="line">&lt;Authorized</span><br><span class="line">  authority=&#123;authority&#125;</span><br><span class="line">  noMatch=&#123;</span><br><span class="line">    &lt;Route</span><br><span class="line">      &#123;...rest&#125;</span><br><span class="line">      render=&#123;() =&gt; &lt;Redirect to=&#123;&#123; pathname: redirectPath &#125;&#125; /&gt;&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&gt;</span><br><span class="line">  &lt;Route</span><br><span class="line">    &#123;...rest&#125;</span><br><span class="line">    render=&#123;props =&gt;</span><br><span class="line">      (Component ? &lt;Component &#123;...props&#125; /&gt; : render(props))</span><br><span class="line">    &#125;</span><br><span class="line">  /&gt;</span><br><span class="line">&lt;/Authorized&gt;</span><br></pre></td></tr></table></figure>
<p>这里就会通过<code>Route</code>组件，将 Layout 中的 Content 区域渲染为对应的内容。</p>
</li>
<li><p>默认路由，这里定义如果访问<code>/</code>这个路径，重定向到哪个路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Redirect exact from=&quot;/&quot; to=&#123;bashRedirect&#125; /&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>路由 NoFound，这里定义如果找不到对应的地址，访问的页面，即 404 页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Route render=&#123;NotFound&#125; /&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="导航栏"><a href="#导航栏" class="headerlink" title="导航栏"></a>导航栏</h3><p>pro 生成的时候提供了导航栏组件<code>SiderMenu</code>，但是因为我们需要自定义的导航栏的需求，这里是使用自己写的导航栏</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// src/layouts/BasicLayout.js</span><br><span class="line">// 传入当前的权限数据，导航栏数据和当前的路由</span><br><span class="line">&lt;LeftSiderMenu</span><br><span class="line">  currentPermission=&#123;currentPermission&#125;</span><br><span class="line">  menuData=&#123;getMenuData()&#125;</span><br><span class="line">  location=&#123;location&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// src/components/LeftSiderMenu</span><br><span class="line">// 首先根据传入的权限数据对导航栏数据进行筛选，然后通过Link生成导航栏，点击就跳转到对应的路由</span><br><span class="line">&lt;div className=&#123;styles.menuContainer&#125;&gt;</span><br><span class="line">  &lt;ul className=&#123;styles.siderMenuUl&#125;&gt;</span><br><span class="line">    &#123;</span><br><span class="line">      subMenuList &amp;&amp; subMenuList.children &amp;&amp; subMenuList.children.map(item =&gt; (</span><br><span class="line">        this.isMenuAuthorized(item) &amp;&amp; (</span><br><span class="line">          &lt;Link key=&#123;item.path&#125; to=&#123;`/$&#123;item.path&#125;`&#125; replace&gt;</span><br><span class="line">            &lt;li className=&#123;`$&#123;parentMenu&#125;/$&#123;subMenu&#125;` === item.path ? styles.active : &apos;&apos;&#125;&gt;</span><br><span class="line">              &lt;div className=&#123;styles.itemBorder&#125; /&gt;</span><br><span class="line">              &lt;div className=&#123;styles.itemIcon&#125; /&gt;</span><br><span class="line">              &lt;div className=&#123;styles.itemContent&#125;&gt;</span><br><span class="line">                &lt;span&gt;&#123;item.name&#125;&lt;/span&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">            &lt;/li&gt;</span><br><span class="line">          &lt;/Link&gt;</span><br><span class="line">        )</span><br><span class="line">      ))</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/09/dva中的connect注解使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxc">
      <meta itemprop="description" content="前端/js/react/vue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴某某嗯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/09/dva中的connect注解使用/" itemprop="url">
                  dva中的connect注解使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-07-09 20:09:57" itemprop="dateCreated datePublished" datetime="2018-07-09T20:09:57+08:00">2018-07-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-12 23:06:02" itemprop="dateModified" datetime="2018-07-12T23:06:02+08:00">2018-07-12</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p>首先看下效果，比如在 LoginPage 组件上面加了如下注解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@connect((&#123; login, loading &#125;) =&gt; (&#123;</span><br><span class="line">  login,</span><br><span class="line">  submitting: loading.effects[&apos;login/login&apos;],</span><br><span class="line">&#125;))</span><br><span class="line">export default class LoginPage extends Component &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>react-redux 从下图中可以看到，注解会自动在 LoginPage 组件外面包裹一层 Connect 组件，这个组件把 redux 状态树中我们需要的值传入 LoginPage 组件的 props 中</p>
<p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-7-9/1699610.jpg" alt=""></p>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>以下是 dva 中 connect 注解的定义（<a href="https://github.com/reactjs/react-router-redux/blob/1a5705fb39331a63b84abc313922d8a3810f1a6d/README.md#how-do-i-access-router-state-in-a-container-component" target="_blank" rel="noopener">简单说明</a>，<a href="https://github.com/reduxjs/react-redux/blob/master/docs/api.md#connectmapstatetoprops-mapdispatchtoprops-mergeprops-options" target="_blank" rel="noopener">详细 API</a>）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Connects a React component to Dva.</span><br><span class="line"> */</span><br><span class="line">export function connect(</span><br><span class="line">  mapStateToProps?: Function,</span><br><span class="line">  mapDispatchToProps?: Function,</span><br><span class="line">  mergeProps?: Function,</span><br><span class="line">  options?: Object</span><br><span class="line">): Function;</span><br></pre></td></tr></table></figure>
<p>对照我们上面的定义，传入了一个 mapStateToProps 的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(&#123; login, loading &#125;) =&gt; (&#123;</span><br><span class="line">  login,</span><br><span class="line">  submitting: loading.effects[&apos;login/login&apos;],</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 等于以下代码</span><br><span class="line">function (state) &#123;</span><br><span class="line">  var login = state.login;</span><br><span class="line">  var loading = state.loading;</span><br><span class="line">  return &#123;</span><br><span class="line">    login: login,</span><br><span class="line">    submitting: loading.effects[&apos;login/login&apos;],</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的作用就是对 redux 中的 state 加工，然后把这里声明的 login 传入到子组件的 Props 中（这里使用了 es6 的解构和箭头函数）</p>
<h3 id="在-dva-中的一个开发流程"><a href="#在-dva-中的一个开发流程" class="headerlink" title="在 dva 中的一个开发流程"></a>在 dva 中的一个开发流程</h3><ol>
<li>在 src/modals 中增加 redux 配置文件，namespace 不能和其他文件重复，配置里面的写法来自<a href="https://redux-saga-in-chinese.js.org/docs/introduction/BeginnerTutorial.html" target="_blank" rel="noopener">redux-saga</a>。比如说我这里叫做 testModal.js，namespace 也是 testModal。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// import &#123; xxx &#125; from &apos;../services/xxx&apos;;</span><br><span class="line">// src/modals/testModal.js</span><br><span class="line">export default &#123;</span><br><span class="line">  namespace: &quot;testModal&quot;,</span><br><span class="line">  state: &#123;&#125;,</span><br><span class="line">  effects: &#123;</span><br><span class="line">    *fetch(&#123; payload &#125;, &#123; call, put &#125;) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  reducers: &#123;</span><br><span class="line">    save(state, action) &#123;</span><br><span class="line">      return &#123;</span><br><span class="line">        ...state,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol>
<li>在 src/common/menu.js 中增加一个目录配置，这里的配置会在导航栏中体现，比如如下配置会在导航栏中显示测试，点击后会访问/testPath 这个页面。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const menuData = [</span><br><span class="line">  &#123;</span><br><span class="line">    name: &apos;测试&apos;,</span><br><span class="line">    icon: &apos;remote&apos;,</span><br><span class="line">    path: &apos;testPath&apos;,</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ol>
<li>在 src/router.js 中增加路径和组件的关系配置，这里会动态加载第一步中的配置文件，dynamicWrapper 中，第二个参数为配置文件的文件名(不是 namespace)，第三个参数是路径对应的组件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">const routerConfig = &#123;</span><br><span class="line">    &apos;/testPath&apos;: &#123;</span><br><span class="line">      component: dynamicWrapper(app, [&apos;testModal&apos;], () =&gt; import(&apos;../routes/TestComponent&apos;)),</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// wrapper of dynamic</span><br><span class="line">const dynamicWrapper = (app, models, component) =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">  // () =&gt; import(&apos;module&apos;)</span><br><span class="line">  return dynamic(&#123;</span><br><span class="line">    app,</span><br><span class="line">    models: () =&gt;</span><br><span class="line">      models.filter(model =&gt; modelNotExisted(app, model)).map(m =&gt; import(`../models/$&#123;m&#125;.js`)),</span><br><span class="line">    // add routerData prop</span><br><span class="line">    component: () =&gt; &#123;</span><br><span class="line">      if (!routerDataCache) &#123;</span><br><span class="line">        routerDataCache = getRouterData(app);</span><br><span class="line">      &#125;</span><br><span class="line">      return component().then(raw =&gt; &#123;</span><br><span class="line">        const Component = raw.default || raw;</span><br><span class="line">        return props =&gt;</span><br><span class="line">          createElement(Component, &#123;</span><br><span class="line">            ...props,</span><br><span class="line">            routerData: routerDataCache,</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol>
<li>编写 TestComponent 中的对应内容即可。</li>
<li>@connect 注解还会传入 dispatch（用于发送 action 和路由跳转）和 history、location、match、routerData 等路由信息。</li>
</ol>
<h3 id="几个注意点："><a href="#几个注意点：" class="headerlink" title="几个注意点："></a>几个注意点：</h3><ol>
<li>如果 dynamicWrapper 中没有加载对应的配置文件，直接在组件中使用@connect 会无效。</li>
<li>如果组件的外层已经被 Connect 组件包裹，可以直接使用@connect，不再需要使用 dynamicWrapper 加载配置（比如上面 TestComponent 中的子组件就可以直接使用@connect），但是范围要在父组件声明范文内（比如上面的例子只能使用 testModal 相关的数据）</li>
<li>namespace 如果重复会出现一些很莫名其妙的问题，比如已经发送 action 但是却不执行。</li>
</ol>
<h3 id="更多参考资料："><a href="#更多参考资料：" class="headerlink" title="更多参考资料："></a>更多参考资料：</h3><p><a href="https://dvajs.com/api/" target="_blank" rel="noopener">dvaAPI</a></p>
<p><a href="https://github.com/dvajs/dva-knowledgemap#dvajs-%E7%9F%A5%E8%AF%86%E5%AF%BC%E5%9B%BE" target="_blank" rel="noopener">dva.js 知识导图</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/22/综合态势v1.0大屏总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxc">
      <meta itemprop="description" content="前端/js/react/vue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴某某嗯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/22/综合态势v1.0大屏总结/" itemprop="url">
                  项目综合态势v1.0大屏总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-06-22 15:47:49" itemprop="dateCreated datePublished" datetime="2018-06-22T15:47:49+08:00">2018-06-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-12 23:56:50" itemprop="dateModified" datetime="2018-07-12T23:56:50+08:00">2018-07-12</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>用时两个星期做的大屏，还是觉得上一个大屏好看一些。</p>
<h2 id="总体结构"><a href="#总体结构" class="headerlink" title="总体结构"></a>总体结构</h2><p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-7-2/40109295.jpg" alt=""></p>
<p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-6-22/92058435.jpg" alt=""></p>
<h2 id="关于不同分辨率适配"><a href="#关于不同分辨率适配" class="headerlink" title="关于不同分辨率适配"></a>关于不同分辨率适配</h2><ul>
<li><p>使用作为 vh 和 vw 长度单位，并设置 max 和 min 值，防止页面过度变形。</p>
</li>
<li><p>根据 Dashboard 组件的高度动态计算每个图表的高度，防止图表出现重叠</p>
<ol>
<li>Dashboard 中监听 resize 事件，实时地获取显示区域的 height</li>
<li>在 LeftBoard 和 RightBoard 中，依据传入的 height 和 count 参数计算每个图表区域（附带标题 ）的高度。因为长度使用了 vh vw 作为单位，所以需要使用 ref 和 getComputedStyle()转化为 px 计算。</li>
</ol>
<p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-6-22/355403.jpg" alt=""></p>
<ol start="3">
<li>在 withTitle 中，计算去标题后的图表大小</li>
</ol>
</li>
</ul>
<h2 id="定时器控制"><a href="#定时器控制" class="headerlink" title="定时器控制"></a>定时器控制</h2><ul>
<li>定时器放在 model 里面生成、销毁(定时器放在子组件中，耦合度低但是开销大；放在父组件中，耦合度高开销大)</li>
<li>使用 saga 的 race 方法(<a href="https://redux-saga-in-chinese.js.org/docs/advanced/RacingEffects.html" target="_blank" rel="noopener">参考链接</a>)，判断 delay(延迟)和取消任务哪个先到来。如果在一个延时周期内，外部没有触发 endTimer 的 action，则执行对应的操作，然后开始下一个周期；如果外部触发了 endTimer，此时 cancel 有值，循环结果，即定时器关闭。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">*interval(&#123; payload &#125;, &#123; race, take &#125;) &#123;</span><br><span class="line">  // 延时时长和操作</span><br><span class="line">  const &#123; time, callback &#125; = payload;</span><br><span class="line">  let finished = false;</span><br><span class="line"></span><br><span class="line">  while (!finished) &#123;</span><br><span class="line">    ...</span><br><span class="line">    // 执行对应的操作</span><br><span class="line">		callback();</span><br><span class="line">    ...</span><br><span class="line">    const &#123; cancel &#125; = yield race(&#123;</span><br><span class="line">      delay: delay(time),</span><br><span class="line">      cancel: take(&apos;endTimer&apos;),</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    if (cancel) &#123;</span><br><span class="line">      finished = true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h2 id="地图"><a href="#地图" class="headerlink" title="地图"></a>地图</h2><h3 id="设备点"><a href="#设备点" class="headerlink" title="设备点"></a>设备点</h3><p>在 mapUtils 中封装了一个创建点的方法，具体的显示在 content 中传入 html，另外在 marker 中保存点信息，在需要获取点信息的地方，通过<code>marker.getExtData()</code>获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  /**</span><br><span class="line">   * 增加一个点</span><br><span class="line">   * @param &#123;object&#125; point 点信息</span><br><span class="line">   * @param &#123;string&#125; showType 显示模式(project、group)</span><br><span class="line">   * @param &#123;object&#125; options 点的其他参数</span><br><span class="line">   */</span><br><span class="line">drawOnePoint(point, showType, options = &#123;&#125;) &#123;</span><br><span class="line">  const marker = new AMap.Marker(&#123;</span><br><span class="line">    position: point.coordinate,</span><br><span class="line">    // 显示的内容</span><br><span class="line">    content: getMarkerContent(point, showType),</span><br><span class="line">    offset: new AMap.Pixel(-12, -12),</span><br><span class="line">    zIndex: 2000,</span><br><span class="line">    // animation: &apos;AMAP_ANIMATION_BOUNCE&apos;,</span><br><span class="line">    ...options,</span><br><span class="line">  &#125;);</span><br><span class="line">  marker.setExtData(&#123; ...point &#125;);</span><br><span class="line">  return marker;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h3 id="弹窗"><a href="#弹窗" class="headerlink" title="弹窗"></a>弹窗</h3><p>高德地图上的弹窗 api 是直接操作 dom 节点，插入 html 字符串，这种方式在简单的页面上比较方便，一旦页面有多个，并且需要动态加载数据之后会一下子变得很麻烦，所以这里使用 react-dom 来显示弹窗页面。</p>
<ol>
<li>首先创建窗体，此时窗体内容为<code>&lt;div id=&#39;xx&#39;&gt;&lt;/div&gt;</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  /**</span><br><span class="line">   * 构建自定义信息窗体</span><br><span class="line">   * @param &#123;object&#125; param 带有id属性的点信息</span><br><span class="line">   */</span><br><span class="line">createInfoWindow(&#123; id &#125;) &#123;</span><br><span class="line">  const info = document.createElement(&apos;div&apos;);</span><br><span class="line">  info.id = id;</span><br><span class="line">  const infoWindow = new AMap.InfoWindow(&#123;</span><br><span class="line">    isCustom: true, // 使用自定义窗体</span><br><span class="line">    content: info,</span><br><span class="line">    offset: new AMap.Pixel(16, -45),</span><br><span class="line">    autoMove: true,</span><br><span class="line">    closeWhenClickMap: true,</span><br><span class="line">  &#125;);</span><br><span class="line">  return infoWindow;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>绑定设备点和窗口的关系</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 绑定点和窗口</span><br><span class="line"> * @param &#123;AMap.Marker&#125; marker 地图上的点</span><br><span class="line"> * @param &#123;AMap.InfoWindow&#125; myWindow 地图上的窗口</span><br><span class="line"> * @param &#123;object&#125; PointWindow 用于渲染到地图窗口中的组件</span><br><span class="line"> */</span><br><span class="line">bindingMarkerWindow(marker, myWindow, PointWindow) &#123;</span><br><span class="line">  const deviceInfo = marker.getExtData();</span><br><span class="line">  // 鼠标点击marker弹出自定义的信息窗体</span><br><span class="line">  AMap.event.addListener(marker, &apos;click&apos;, () =&gt; &#123;</span><br><span class="line">    // 在点的位置打开窗口</span><br><span class="line">    myWindow.open(marker.getMap(), marker.getPosition());</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  // 打开窗口时渲染组件</span><br><span class="line">  AMap.event.addListener(myWindow, &apos;open&apos;, e =&gt; &#123;</span><br><span class="line">    // console.log(e, &apos;before&apos;, node, );</span><br><span class="line">    ReactDOM.render(</span><br><span class="line">      &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">        &lt;PointWindow deviceId=&#123;deviceInfo.id&#125; /&gt;</span><br><span class="line">      &lt;/Provider&gt;,</span><br><span class="line">      e.target.getContent()</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  // 关闭窗口时，从dom中删除组件</span><br><span class="line">  AMap.event.addListener(myWindow, &apos;close&apos;, () =&gt; &#123;</span><br><span class="line">    ReactDOM.unmountComponentAtNode(document.getElementById(deviceInfo.id));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><strong>注</strong>：在渲染组件的时候，需要再外面包一层<code>&lt;Provider store={store}&gt;...&lt;/Provider&gt;</code>，将外面全局 redux 的 store 传入，不然<code>&lt;PointWindow /&gt;</code>中的<code>@connect()</code>将不能正常使用。react 渲染结果如下</p>
<p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-7-2/68321113.jpg" alt=""></p>
<h2 id="图表"><a href="#图表" class="headerlink" title="图表"></a>图表</h2><p>使用 bizcharts 图表组件，图表的所有颜色定义等属性放在<code>constant.js</code>文件中，图表组件放在<code>components/Charts</code>中。</p>
<h3 id="自定义形状"><a href="#自定义形状" class="headerlink" title="自定义形状"></a>自定义形状</h3><p>柱状图使用圆角矩形需要自己通过 canvas 绘制，在<code></code>components/Charts/g2.js`中添加新的形状，具体的使用参考<a href="https://github.com/alibaba/BizCharts/blob/master/doc/api/shape.md" target="_blank" rel="noopener">bizcharts-shape 文档</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// 自定义 shape, 水平方向柱状图圆角矩形</span><br><span class="line">Shape.registerShape(&apos;interval&apos;, &apos;borderRadiusH&apos;, &#123;</span><br><span class="line">  draw(cfg, container) &#123;</span><br><span class="line">    const &#123; points &#125; = cfg;</span><br><span class="line">    const parsePoints = this.parsePoints(points); // 将 0 - 1 转化为画布坐标</span><br><span class="line">    let width = (parsePoints[2].x - parsePoints[1].x) * 0.6;</span><br><span class="line">    width = width &gt; MAX_WIDTH ? MAX_WIDTH : width;</span><br><span class="line">    const attrs = &#123;</span><br><span class="line">      x: (parsePoints[2].x + parsePoints[1].x - width) / 2, // 矩形起始点为左下角</span><br><span class="line">      y: parsePoints[1].y,</span><br><span class="line">      width,</span><br><span class="line">      height: parsePoints[0].y - parsePoints[1].y,</span><br><span class="line">      fill: cfg.color,</span><br><span class="line">      radius: width / 2,</span><br><span class="line">    &#125;;</span><br><span class="line">    return container.addShape(&apos;rect&apos;, &#123;</span><br><span class="line">      attrs,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>使用时在 shape 中使用之前注册形状即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Geom type=&quot;interval&quot; shape=&quot;borderRadiusH&quot; position=&quot;x*y&quot; color=&#123;color&#125; /&gt;</span><br></pre></td></tr></table></figure>
<h3 id="自定义图例"><a href="#自定义图例" class="headerlink" title="自定义图例"></a>自定义图例</h3><ul>
<li>加上 useHtml 代表使用 html 生成图例(默认为 canvas)</li>
<li>containerTpl 控制图例的整体显示，itemTpl 控制图例中的每一项显示，推荐加上 g2 的相关 class 进行微调。</li>
<li>如果不需要 html 修改结构，也可以通过 css 覆盖原有的 class 属性。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;Legend</span><br><span class="line">  position=&quot;top&quot;</span><br><span class="line">  useHtml</span><br><span class="line">  containerTpl=&#123;`</span><br><span class="line">    &lt;div class=&quot;g2-legend topLegend&quot;&gt;</span><br><span class="line">      &lt;h4 class=&quot;g2-legend-title&quot;&gt;&lt;/h4&gt;</span><br><span class="line">      &lt;ul class=&quot;g2-legend-list&quot; style=&quot;list-style-type:none;margin:0;padding:0;&quot;&gt;&lt;/ul&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  `&#125;</span><br><span class="line">  itemTpl=&#123;(value, itemColor, checked, index) =&gt; &#123;</span><br><span class="line">    return `&lt;tr</span><br><span class="line">      class=&quot;g2-legend-list-item item-$&#123;index&#125; $&#123;checked ? &apos;checked&apos; : &apos;unChecked&apos;&#125;&quot;</span><br><span class="line">      data-value=&quot;$&#123;value&#125;&quot;</span><br><span class="line">      data-color=$&#123;color[value]&#125; &gt;</span><br><span class="line">        &lt;td &gt;</span><br><span class="line">          &lt;i class=&quot;g2-legend-marker&quot; style=&quot;width:10px;height:10px;display:inline-block;margin-right:10px;background-color:$&#123;</span><br><span class="line">          color[value]</span><br><span class="line">          &#125;;&quot;&gt;&lt;/i&gt;</span><br><span class="line">        &lt;span  class=&quot;g2-legend-text title&quot;&gt;$&#123;value&#125;&lt;/span&gt;&lt;/td&gt;</span><br><span class="line">    	&lt;/tr&gt;`;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<h3 id="图表混合"><a href="#图表混合" class="headerlink" title="图表混合"></a>图表混合</h3><p>面积图和折线图混合，是一份数据同时画两个图表，每个图表中设置一个数据为透明，这样两个图表叠加起来，就看起来是一个面积图案加一个折线图案。</p>
<h3 id="颜色渐变"><a href="#颜色渐变" class="headerlink" title="颜色渐变"></a>颜色渐变</h3><p>通过设置图表颜色为<code>l(90) 0:#4DE8E9 1:#408ca8e6</code>来显示渐变<br><a href="https://antv.alipay.com/zh-cn/g2/3.x/api/graphic.html#_%E6%B8%90%E5%8F%98%E8%89%B2" target="_blank" rel="noopener">渐变色文档</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/10/ant-design-pro中的权限控制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxc">
      <meta itemprop="description" content="前端/js/react/vue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴某某嗯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/10/ant-design-pro中的权限控制/" itemprop="url">
                  ant design pro中的权限控制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-06-10 17:05:20" itemprop="dateCreated datePublished" datetime="2018-06-10T17:05:20+08:00">2018-06-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-12 23:58:56" itemprop="dateModified" datetime="2018-07-12T23:58:56+08:00">2018-07-12</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>因为后端使用 shiro 控制权限， 用户登录的时候返回的权限信息类似于</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'test/view'</span>, <span class="string">'test/add'</span>, <span class="string">'test/edit'</span>];</span><br></pre></td></tr></table></figure>
<p>仔细看了下 ant design pro 的权限控制组件后发现，可以很好地结合使用</p>
<h3 id="1-mock-登录返回数据"><a href="#1-mock-登录返回数据" class="headerlink" title="1. mock 登录返回数据"></a>1. mock 登录返回数据</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (password === <span class="string">'123'</span> &amp;&amp; userName === <span class="string">'wxc'</span>) &#123;</span><br><span class="line">  res.send(&#123;</span><br><span class="line">    status: <span class="string">'ok'</span>,</span><br><span class="line">    type,</span><br><span class="line">    currentAuthority: [</span><br><span class="line">      <span class="string">'test/view'</span>, <span class="comment">// 页面浏览权限</span></span><br><span class="line">      <span class="string">'test/add'</span>, <span class="comment">// 页面添加按钮权限</span></span><br><span class="line">      <span class="string">'test/edit'</span>, <span class="comment">// 编辑按钮权限</span></span><br><span class="line">    ],</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-修改-antd-pro-的权限组件"><a href="#2-修改-antd-pro-的权限组件" class="headerlink" title="2. 修改 antd pro 的权限组件"></a>2. 修改 antd pro 的权限组件</h3><p>因为框架已经自带了权限组件，但是这里的权限组件是通过<code>&#39;admin&#39;</code>，<code>&#39;user&#39;</code>这种字符串判断，而我们是登录后返回一个数组，所以要稍微修改下里面的权限判断逻辑</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/components/Authorized/CheckPermissions.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通用权限检查方法</span></span><br><span class="line"><span class="comment"> * Common check permissions method</span></span><br><span class="line"><span class="comment"> * @param &#123; 权限判定 Permission judgment type string |array | Promise | Function &#125; authority</span></span><br><span class="line"><span class="comment"> * @param &#123; 你的权限 Your permission description  type:string&#125; currentAuthorityString</span></span><br><span class="line"><span class="comment"> * @param &#123; 通过的组件 Passing components &#125; target</span></span><br><span class="line"><span class="comment"> * @param &#123; 未通过的组件 no pass components &#125; Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> checkPermissions = <span class="function">(<span class="params">authority, currentAuthorityString, target, Exception</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 没有判定权限.默认查看所有,开发的时候可以使用</span></span><br><span class="line">  <span class="comment">// Retirement authority, return target</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当前获取的权限处理成数组</span></span><br><span class="line">  <span class="keyword">const</span> currentAuthority = currentAuthorityString.split(<span class="string">','</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!authority) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 数组处理</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(authority)) &#123;</span><br><span class="line">    <span class="keyword">let</span> flag = <span class="literal">false</span>;</span><br><span class="line">    authority.some(<span class="function"><span class="params">au</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (currentAuthority.indexOf(au) !== <span class="number">-1</span>) &#123;</span><br><span class="line">        flag = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">      <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Exception;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// string 处理</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> authority === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (currentAuthority.indexOf(authority) !== <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Exception;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// promise和function</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'unsupported parameters'</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>修改完毕之后就可以正常使用权限组件了</p>
<h2 id="3-记录用户权限"><a href="#3-记录用户权限" class="headerlink" title="3. 记录用户权限"></a>3. 记录用户权限</h2><p>登录获取到接口返回的权限信息后，通过工具类中封装好的<code>setAuthority</code>方法在 localStorage 中保存权限信息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; setAuthority &#125; <span class="keyword">from</span> <span class="string">'../utils/authority'</span>;</span><br><span class="line">...</span><br><span class="line">	setAuthority(payload.currentAuthority);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-6-10/36808770.jpg" alt=""></p>
<p>保存权限信息完毕之后，还需要通过<code>reloadAuthorized</code>方法来刷新权限组件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reloadAuthorized &#125; <span class="keyword">from</span> <span class="string">'../utils/Authorized'</span>;</span><br><span class="line">...</span><br><span class="line">	reloadAuthorized();</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>下面就可以正常使用 ant design pro 的权限控制功能了</p>
<h2 id="4-权限控制方式"><a href="#4-权限控制方式" class="headerlink" title="4. 权限控制方式"></a>4. 权限控制方式</h2><h3 id="控制菜单显示"><a href="#控制菜单显示" class="headerlink" title="控制菜单显示"></a>控制菜单显示</h3><p>这种方式下，路由导向也会做相应的控制，推荐使用这种方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/common/menu.js</span></span><br><span class="line">&#123;</span><br><span class="line">   name: <span class="string">'权限测试页面'</span>,</span><br><span class="line">   icon: <span class="string">'user'</span>,</span><br><span class="line">   path: <span class="string">'test'</span>,</span><br><span class="line">   authority: <span class="string">'test/view'</span>,</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>
<h3 id="控制路由导向"><a href="#控制路由导向" class="headerlink" title="控制路由导向"></a>控制路由导向</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/common/router.js</span></span><br><span class="line"><span class="string">'/test'</span>: &#123;</span><br><span class="line">  component: dynamicWrapper(app, [], () =&gt; <span class="keyword">import</span>(<span class="string">'../routes/Test'</span>)),</span><br><span class="line">  authority: <span class="string">'test/view'</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Authorized <span class="keyword">from</span> <span class="string">'../../utils/Authorized'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Secured &#125; = Authorized;</span><br><span class="line"></span><br><span class="line">@Secured(<span class="string">'test/view'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="页面内组件控制"><a href="#页面内组件控制" class="headerlink" title="页面内组件控制"></a>页面内组件控制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Authorized <span class="keyword">from</span> <span class="string">'../../utils/Authorized'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> noMatch = &lt;div&gt;没有权限&lt;/div&gt;;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        权限测试页面</span><br><span class="line">        &lt;Authorized authority=<span class="string">"test/add"</span> noMatch=&#123;noMatch&#125;&gt;</span><br><span class="line">          &lt;button&gt;添加&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>Authorized&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>效果如下：<img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-6-10/13648508.jpg" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/08/vscode插件安利/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxc">
      <meta itemprop="description" content="前端/js/react/vue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴某某嗯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/08/vscode插件安利/" itemprop="url">
                  插件安利
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-06-08 16:22:07" itemprop="dateCreated datePublished" datetime="2018-06-08T16:22:07+08:00">2018-06-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-12 23:02:15" itemprop="dateModified" datetime="2018-07-12T23:02:15+08:00">2018-07-12</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-Bracket-Pair-Colorizer"><a href="#1-Bracket-Pair-Colorizer" class="headerlink" title="1. Bracket Pair Colorizer"></a>1. Bracket Pair Colorizer</h3><p>括号高亮</p>
<p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-6-8/91848322.jpg" alt=""></p>
<h3 id="2-Atom-One-Dark-Theme"><a href="#2-Atom-One-Dark-Theme" class="headerlink" title="2. Atom One Dark Theme"></a>2. Atom One Dark Theme</h3><p>字体配色</p>
<p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-6-8/47756484.jpg" alt=""></p>
<h3 id="3-Code-Spell-Checker"><a href="#3-Code-Spell-Checker" class="headerlink" title="3. Code Spell Checker"></a>3. Code Spell Checker</h3><p>单词拼写校验</p>
<p><img src="https://raw.githubusercontent.com/Jason-Rev/vscode-spell-checker/master/client/images/suggestions.gif" alt=""></p>
<h3 id="4-Import-Cost"><a href="#4-Import-Cost" class="headerlink" title="4. Import Cost"></a>4. Import Cost</h3><p>import 消耗计算</p>
<p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-6-8/50194848.jpg" alt=""></p>
<h3 id="5-Less-IntelliSense"><a href="#5-Less-IntelliSense" class="headerlink" title="5. Less IntelliSense"></a>5. Less IntelliSense</h3><p>less 文件代码补全</p>
<h3 id="6-Material-Icon-Theme"><a href="#6-Material-Icon-Theme" class="headerlink" title="6. Material Icon Theme"></a>6. Material Icon Theme</h3><p>文件图标</p>
<p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-6-8/75328121.jpg" alt=""></p>
<h3 id="7-Open-in-Browser"><a href="#7-Open-in-Browser" class="headerlink" title="7. Open in Browser"></a>7. Open in Browser</h3><p>在 html 文件右键菜单上增加在浏览器上打开</p>
<h3 id="8-React-Native-React-Redux-snippets-for-es6-es7"><a href="#8-React-Native-React-Redux-snippets-for-es6-es7" class="headerlink" title="8. React-Native/React/Redux snippets for es6/es7"></a>8. React-Native/React/Redux snippets for es6/es7</h3><p>常用代码片段</p>
<p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-6-8/10962993.jpg" alt=""></p>
<h3 id="9-SVG-Viewer"><a href="#9-SVG-Viewer" class="headerlink" title="9. SVG Viewer"></a>9. SVG Viewer</h3><p>浏览 svg 文件，转 svg 文件为 png 文件</p>
<p><img src="https://github.com/cssho/vscode-svgviewer/raw/master/img/from_context.gif" alt=""></p>
<h3 id="10-Auto-Close-Tag"><a href="#10-Auto-Close-Tag" class="headerlink" title="10. Auto Close Tag"></a>10. Auto Close Tag</h3><p>自动闭合标签</p>
<p><img src="https://github.com/formulahendry/vscode-auto-close-tag/raw/master/images/usage.gif" alt=""></p>
<h3 id="11-Auto-Rename-Tag"><a href="#11-Auto-Rename-Tag" class="headerlink" title="11. Auto Rename Tag"></a>11. Auto Rename Tag</h3><p>闭合标签一起修改名字</p>
<p><img src="https://github.com/formulahendry/vscode-auto-rename-tag/raw/master/images/usage.gif" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/15/egg中的路由和中间件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxc">
      <meta itemprop="description" content="前端/js/react/vue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴某某嗯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/15/egg中的路由和中间件/" itemprop="url">
                  egg中的路由和中间件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-05-15 17:31:30" itemprop="dateCreated datePublished" datetime="2018-05-15T17:31:30+08:00">2018-05-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-12 23:37:17" itemprop="dateModified" datetime="2018-07-12T23:37:17+08:00">2018-07-12</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>18 年 5 月内部分享时用的 node ppt 整理</p>
<h1 id="Router-路由"><a href="#Router-路由" class="headerlink" title="Router 路由"></a>Router 路由</h1><h1 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h1><ul>
<li>Router 主要用来描述请求 URL 和具体承担执行动作的 Controller 的对应关系， 框架约定了 <code>app/router.js</code> 文件用于统一所有路由规则。</li>
<li>通过统一的配置，我们可以避免路由规则逻辑散落在多个地方，从而出现未知的冲突，集中在一起我们可以更方便的来查看全局的路由规则。</li>
</ul>
<h2 id="如何定义-Router"><a href="#如何定义-Router" class="headerlink" title="如何定义 Router"></a>如何定义 Router</h2><p><code>app/router.js</code> 里面定义 URL 路由规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// app/router.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  const &#123; router, controller &#125; = app;</span><br><span class="line">  router.get(&apos;/user/:id&apos;, controller.user.info);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>app/controller</code> 目录下面实现 Controller</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// app/controller/user.js</span><br><span class="line">class UserController extends Controller &#123;</span><br><span class="line">  async info() &#123;</span><br><span class="line">    const &#123; ctx &#125; = this;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      name: `hello $&#123;ctx.params.id&#125;`,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当用户执行 <code>GET /user/123</code>，<code>app/controller/user.js</code> 这个里面的 info 方法就会执行。</p>
<h1 id="Router-详细定义说明"><a href="#Router-详细定义说明" class="headerlink" title="Router 详细定义说明"></a>Router 详细定义说明</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.verb(&apos;router-name&apos;, &apos;path-match&apos;, middleware1, ..., middlewareN, app.controller.action);</span><br></pre></td></tr></table></figure>
<p>路由完整定义主要包括 5 个主要部分(<strong>有颜色部分为必填</strong>):</p>
<ul>
<li><strong>verb</strong> - 用户触发动作，支持 get，post 等所有 HTTP 方法。</li>
<li>router - name 给路由设定一个别名，可以通过 Helper 提供的辅助函数 <code>pathFor</code> 和 <code>urlFor</code> 来生成 URL。</li>
<li><strong>path-match</strong> - 路由 URL 路径。</li>
<li>middleware1 - 在 Router 里面可以配置多个 Middleware。</li>
<li><p><strong>controller</strong> - 指定路由映射到的具体的 controller 上，controller 可以有两种写法：</p>
<ul>
<li><code>app.controller.user.fetch</code> - 直接指定一个具体的 controller</li>
<li><code>&#39;user.fetch&#39;</code> - 可以简写为字符串形式</li>
</ul>
</li>
</ul>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul>
<li>在 Router 定义中， 可以支持多个 Middleware 串联执行</li>
<li>Controller 必须定义在 <code>app/controller</code> 目录中。</li>
<li>一个文件里面也可以包含多个 Controller 定义，在定义路由的时候，可以通过 <code>${fileName}.${functionName}</code> 的方式指定对应的 Controller。</li>
<li>Controller 支持子目录，在定义路由的时候，可以通过 <code>${directoryName}.${fileName}.${functionName}</code>的方式制定对应的 Controller。</li>
</ul>
<h1 id="RESTful-风格的-URL-定义"><a href="#RESTful-风格的-URL-定义" class="headerlink" title="RESTful 风格的 URL 定义"></a>RESTful 风格的 URL 定义</h1><ul>
<li>如果想通过 RESTful 的方式来定义路由，使用  <code>app.resources(&#39;routerName&#39;, &#39;pathMatch&#39;, controller)</code>  快速在一个路径上生成  <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete" target="_blank" rel="noopener">CRUD</a>  路由结构。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// app/router.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  const &#123; router, controller &#125; = app;</span><br><span class="line">  router.resources(&apos;posts&apos;, controller.posts);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>上面代码就在 <code>/posts</code> 路径上部署了一组 CRUD 路径结构，对应的 Controller 为 <code>app/controller/posts.js</code> 接下来， 你只需要在 <code>posts.js</code> 里面实现对应的函数就可以了。</p>
<p>| Method | Path            | Route Name | Controller.Action             |<br>| —— | ————— | ———- | —————————– |<br>| GET    | /posts          | posts      | app.controllers.posts.index   |<br>| GET    | /posts/new      | new_post   | app.controllers.posts.new     |<br>| GET    | /posts/:id      | post       | app.controllers.posts.show    |<br>| GET    | /posts/:id/edit | edit_post  | app.controllers.posts.edit    |<br>| POST   | /posts          | posts      | app.controllers.posts.create  |<br>| PUT    | /posts/:id      | post       | app.controllers.posts.update  |<br>| DELETE | /posts/:id      | post       | app.controllers.posts.destroy |</p>
</li>
</ul>
<h1 id="获取-Query-String-参数"><a href="#获取-Query-String-参数" class="headerlink" title="获取 Query String 参数"></a>获取 Query String 参数</h1><ul>
<li>使用<code>ctx.query</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// app/router.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  app.router.get(&apos;/params&apos;, controller.params.queryString);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// app/controller/params.js</span><br><span class="line">exports.queryString = async ctx =&gt; &#123;</span><br><span class="line">  ctx.body = `search: $&#123;ctx.query.name&#125;`;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// curl http://127.0.0.1:7001/params?name=egg</span><br></pre></td></tr></table></figure>
<h1 id="获取-URL-中的参数"><a href="#获取-URL-中的参数" class="headerlink" title="获取 URL 中的参数"></a>获取 URL 中的参数</h1><ul>
<li>使用<code>ctx.params</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// app/router.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  app.router.get(&apos;/params/:id/:name&apos;, controller.params.urlParams);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// app/controller/params.js</span><br><span class="line">exports.urlParams = async ctx =&gt; &#123;</span><br><span class="line">  ctx.body = `user: $&#123;ctx.params.id&#125;, $&#123;ctx.params.name&#125;`;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// curl http://127.0.0.1:7001/params/123/xiaoming</span><br></pre></td></tr></table></figure>
<ul>
<li>注：<ul>
<li>路由里面也支持定义正则，可以更加灵活的获取参数</li>
</ul>
</li>
</ul>
<h1 id="表单内容获取"><a href="#表单内容获取" class="headerlink" title="表单内容获取"></a>表单内容获取</h1><ul>
<li>使用<code>ctx.request.body</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// app/router.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  app.router.post(&apos;/params&apos;, app.controller.params.bodyParam);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// app/controller/params.js</span><br><span class="line">exports.bodyParam = async ctx =&gt; &#123;</span><br><span class="line">  ctx.body = `body: $&#123;JSON.stringify(ctx.request.body)&#125;`;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="内部重定向"><a href="#内部重定向" class="headerlink" title="内部重定向"></a>内部重定向</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// app/router.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  app.router.get(&apos;index&apos;, &apos;/home/index&apos;, app.controller.home.index);</span><br><span class="line">  app.router.redirect(&apos;/&apos;, &apos;/home/index&apos;, 302);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// app/controller/home.js</span><br><span class="line">exports.index = async ctx =&gt; &#123;</span><br><span class="line">  ctx.body = &apos;hello controller&apos;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// curl -L http://localhost:7001</span><br></pre></td></tr></table></figure>
<h1 id="外部重定向"><a href="#外部重定向" class="headerlink" title="外部重定向"></a>外部重定向</h1><ul>
<li>使用<code>ctx.redirect()</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// app/router.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  app.router.get(&apos;/baidu&apos;, controller.params.baidu);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// app/controller/params.js</span><br><span class="line">exports.baidu = async ctx =&gt; &#123;</span><br><span class="line">  const q = ctx.query.q || &apos;nodejs&apos;;</span><br><span class="line">  ctx.redirect(`https://www.baidu.com/s?wd=$&#123;q&#125;`);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="路由整理"><a href="#路由整理" class="headerlink" title="路由整理"></a>路由整理</h1><ul>
<li>将相关的模块整合放在同一个文件中，在<code>app/router.js</code>中统一调用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// app/router.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  require(&apos;./router/params&apos;)(app);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// app/router/params.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  app.router.get(&apos;/params&apos;, controller.params.queryString);</span><br><span class="line">  app.router.get(&apos;/params/:id/:name&apos;, controller.params.urlParams);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h1><h1 id="背景环境"><a href="#背景环境" class="headerlink" title="背景环境"></a>背景环境</h1><ul>
<li>Egg 2.x 基于 Koa 2.x，框架底层以及所有内置插件都使用<code>async function</code>编写</li>
</ul>
<h1 id="Koa-的洋葱圈模型"><a href="#Koa-的洋葱圈模型" class="headerlink" title="Koa 的洋葱圈模型"></a>Koa 的洋葱圈模型</h1><p><img src="https://camo.githubusercontent.com/d80cf3b511ef4898bcde9a464de491fa15a50d06/68747470733a2f2f7261772e6769746875622e636f6d2f66656e676d6b322f6b6f612d67756964652f6d61737465722f6f6e696f6e2e706e67" alt=""></p>
<h1 id="Koa-中间件的执行顺序"><a href="#Koa-中间件的执行顺序" class="headerlink" title="Koa 中间件的执行顺序"></a>Koa 中间件的执行顺序</h1><p><img src="https://raw.githubusercontent.com/koajs/koa/a7b6ed0529a58112bac4171e4729b8760a34ab8b/docs/middleware.gif" alt=""></p>
<h1 id="egg-中间件"><a href="#egg-中间件" class="headerlink" title="egg 中间件"></a>egg 中间件</h1><ul>
<li>Egg 是基于 Koa 实现的，所以 Egg 的中间件形式和 Koa 的中间件形式是一样的，都是基于洋葱圈模型。每次我们编写一个中间件，就相当于在洋葱外面包了一层。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// /app/middleware/text.js</span><br><span class="line"></span><br><span class="line">module.exports = () =&gt; &#123;</span><br><span class="line">  return async function text(ctx, next) &#123;</span><br><span class="line">    const query = ctx.query;</span><br><span class="line">    console.log(query);</span><br><span class="line">    await next();</span><br><span class="line">    const body = ctx.body;</span><br><span class="line">    console.log(JSON.stringify(query), body);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// /config/config.default.js</span><br><span class="line">config.middleware = [ &apos;text&apos; ];</span><br></pre></td></tr></table></figure>
<ul>
<li>egg 约定一个中间件是一个放置在<code>app/middleware</code>目录下的单独文件，它需要 exports 一个普通的 function</li>
</ul>
<h1 id="中间件参数配置"><a href="#中间件参数配置" class="headerlink" title="中间件参数配置"></a>中间件参数配置</h1><p>中间件 exports 的 function，接受两个参数：</p>
<ul>
<li>options: 中间件的配置项，框架会将 <code>app.config[middlewareName]</code> 传递进来。</li>
<li>app: 当前应用 Application 的实例。</li>
</ul>
<h1 id="框架和插件中使用中间件"><a href="#框架和插件中使用中间件" class="headerlink" title="框架和插件中使用中间件"></a>框架和插件中使用中间件</h1><ul>
<li>框架和插件不支持在 <code>config.default.js</code> 中匹配 <code>middleware</code>，需要通过以下方式：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// app.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  // 在中间件最前面统计请求时间</span><br><span class="line">  app.config.coreMiddleware.unshift(&apos;report&apos;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// app/middleware/report.js</span><br><span class="line">module.exports = () =&gt; &#123;</span><br><span class="line">  return async function (ctx, next) &#123;</span><br><span class="line">    const startTime = Date.now();</span><br><span class="line">    await next();</span><br><span class="line">    // 上报请求时间</span><br><span class="line">    reportTime(Date.now() - startTime);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="router-中使用中间件"><a href="#router-中使用中间件" class="headerlink" title="router 中使用中间件"></a>router 中使用中间件</h1><ul>
<li>以上两种方式配置的中间件是全局的，会处理每一次请求。 如果你只想针对单个路由生效，可以直接在 <code>app/router.js</code> 中实例化和挂载</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// /app/router.js</span><br><span class="line">module.exports = app =&gt; &#123;</span><br><span class="line">  const &#123; router, controller &#125; = app;</span><br><span class="line"></span><br><span class="line">  // 直接传递参数</span><br><span class="line">  // const logMiddleware = app.middleware.log(&#123; a: &apos; log in router &apos; &#125;);</span><br><span class="line">  // 使用config中的参数</span><br><span class="line">  const logMiddleware = app.middleware.log(app.config.log);</span><br><span class="line">  router.get(&apos;/text&apos;, logMiddleware, controller.home.index);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="框架默认中间件"><a href="#框架默认中间件" class="headerlink" title="框架默认中间件"></a>框架默认中间件</h1><ul>
<li>除了应用层加载中间件之外，框架自身和其他的插件也会加载许多中间件。所有的这些自带中间件的配置项都通过在配置中修改中间件同名配置项进行修改，例如框架自带的中间件中有一个 bodyParser 中间件（框架的加载器会将文件名中的各种分隔符都修改成驼峰形式的变量名），我们想要修改 bodyParser 的配置，只需要在 <code>config/config.default.js</code> 中编写</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  bodyParser: &#123;</span><br><span class="line">    jsonLimit: &apos;10mb&apos;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>注意：框架和插件加载的中间件会在应用层配置的中间件之前，框架默认中间件不能被应用层中间件覆盖，如果应用层有自定义同名中间件，在启动时会报错。</strong></p>
<h1 id="通用配置"><a href="#通用配置" class="headerlink" title="通用配置"></a>通用配置</h1><p>无论是应用层加载的中间件还是框架自带中间件，都支持几个通用的配置项(<code>config/config.default.js</code>)：</p>
<ul>
<li>enable：控制中间件是否开启。</li>
<li>match：设置只有符合某些规则的请求才会经过这个中间件。</li>
<li>ignore：设置符合某些规则的请求不经过这个中间件。</li>
</ul>
<h1 id="enable"><a href="#enable" class="headerlink" title="enable"></a>enable</h1><ul>
<li>如果我们的应用并不需要默认的 bodyParser 中间件来进行请求体的解析，此时我们可以通过配置 enable 为 false 来关闭它</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  bodyParser: &#123;</span><br><span class="line">    enable: false,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="match-和-ignore"><a href="#match-和-ignore" class="headerlink" title="match 和 ignore"></a>match 和 ignore</h1><ul>
<li>match 和 ignore 支持的参数都一样，只是作用完全相反，match 和 ignore 不允许同时配置。</li>
<li>如果我们想让 gzip 只针对 <code>/static</code> 前缀开头的 url 请求开启，我们可以配置 match 选项</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  gzip: &#123;</span><br><span class="line">    match: &apos;/static&apos;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="match-和-ignore-支持多种类型的配置方式"><a href="#match-和-ignore-支持多种类型的配置方式" class="headerlink" title="match 和 ignore 支持多种类型的配置方式"></a>match 和 ignore 支持多种类型的配置方式</h2><ol>
<li>字符串：当参数为字符串类型时，配置的是一个 url 的路径前缀，所有以配置的字符串作为前缀的 url 都会匹配上。</li>
<li>正则：当参数为正则时，直接匹配满足正则验证的 url 的路径。</li>
<li>函数：当参数为一个函数时，会将请求上下文传递给这个函数，最终取函数返回的结果（ture/false）来判断是否匹配。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  gzip: &#123;</span><br><span class="line">    match(ctx) &#123;</span><br><span class="line">      // 只有 ios 设备才开启</span><br><span class="line">      const reg = /iphone|ipad|ipod/i;</span><br><span class="line">      return reg.test(ctx.get(&apos;user-agent&apos;));</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="谢谢！"><a href="#谢谢！" class="headerlink" title="谢谢！"></a>谢谢！</h1>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/14/异步I-O分享/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxc">
      <meta itemprop="description" content="前端/js/react/vue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴某某嗯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/14/异步I-O分享/" itemprop="url">
                  异步I/O分享
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-01-14 16:20:43" itemprop="dateCreated datePublished" datetime="2018-01-14T16:20:43+08:00">2018-01-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-12 23:31:05" itemprop="dateModified" datetime="2018-07-12T23:31:05+08:00">2018-07-12</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="node-js-异步-I-O"><a href="#node-js-异步-I-O" class="headerlink" title="node.js-异步 I/O"></a>node.js-异步 I/O</h1><p>18 年 1 月份内部分享时用的 node ppt 整理</p>
<h1 id="背景环境"><a href="#背景环境" class="headerlink" title="背景环境"></a>背景环境</h1><ul>
<li>异步最早出现在操作系统的底层，通过信号量、消息等方式有广泛的应用</li>
<li>伴随着 AJAX(<strong>Asynchronous JavaScript and XML</strong>)席卷了 Web，前端编程中充斥着各种 AJAX 和事件，这些都是典型的异步应用场景。在 Node 出现前，前端工程师是最习惯异步编程的程序员</li>
<li>在大多数高级编程语言中，习惯采用同步的方式编写应用——<strong>异步不适合进行程序设计</strong></li>
<li>Node 是首个将异步作为主要的编程方式和设计理念的，伴随着异步 I/O 的还有<strong>事件驱动</strong>和<strong>单线程</strong>，一同构成 Node 的基调</li>
</ul>
<h1 id="为什么要异步-I-O"><a href="#为什么要异步-I-O" class="headerlink" title="为什么要异步 I/O"></a>为什么要异步 I/O</h1><ul>
<li>用户体验</li>
<li>资源分配</li>
</ul>
<h1 id="用户体验"><a href="#用户体验" class="headerlink" title="用户体验"></a>用户体验</h1><ul>
<li>如果网页需要获取一个网络资源，通过同步的方式获取，那么在获取资源资源的这段时间里 UI 将停顿，用户体验会很差。所以在资源下载期间，需要通过异步消除 UI 阻塞现象</li>
<li>并发请求资源，后端快速响应资源</li>
<li><img src="http://oy1qb3tnj.bkt.clouddn.com/1516017516611.jpg" alt=""></li>
</ul>
<h1 id="系统资源分配"><a href="#系统资源分配" class="headerlink" title="系统资源分配"></a>系统资源分配</h1><h2 id="多线程和单线程"><a href="#多线程和单线程" class="headerlink" title="多线程和单线程"></a>多线程和单线程</h2><p>多线程并行完成</p>
<ul>
<li>在多核 CPU 上面能够有效<strong>提升 CPU 的利用率</strong></li>
<li>创建线程和执行期线程上下文切换的开销大常常<strong>面临锁、状态同步等问题</strong></li>
</ul>
<p>单线程串行完成</p>
<ul>
<li>符合顺序思考的思维方式，<strong>易于表达</strong></li>
<li>性能较低，一个略慢的任务都会导致后续执行代码被<strong>阻塞</strong></li>
</ul>
<h1 id="两种模型对比"><a href="#两种模型对比" class="headerlink" title="两种模型对比"></a>两种模型对比</h1><p><img src="http://oy1qb3tnj.bkt.clouddn.com/1516082271306.jpg" alt=""></p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/1516082228190.jpg" alt=""></p>
<h1 id="Node-的选择"><a href="#Node-的选择" class="headerlink" title="Node 的选择"></a>Node 的选择</h1><ul>
<li><p>使用单线程，远离多线程死锁、状态同步等问题，减少资源使用</p>
</li>
<li><p>利用异步 IO，让主线程远离阻塞，提高 CPU 使用效率</p>
<p>​</p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/IMG_20180117_104414-min.jpg" alt=""></p>
</li>
</ul>
<h1 id="异步-IO-的实现"><a href="#异步-IO-的实现" class="headerlink" title="异步 IO 的实现"></a>异步 IO 的实现</h1><ul>
<li>事件循环</li>
<li>观察者</li>
<li>请求对象</li>
<li>执行回调</li>
</ul>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/IMG_20180117_101605-min.jpg" alt=""></p>
<h1 id="Node-的特点"><a href="#Node-的特点" class="headerlink" title="Node 的特点"></a>Node 的特点</h1><ul>
<li>异步 I/O</li>
<li>事件与回调函数</li>
<li>单线程</li>
<li>跨平台</li>
</ul>
<blockquote>
<p>Node 通过事件驱动的方式处理请求，无须为每一个请求创建额外的对应线程，可以省掉创建线程和销毁线程的开销，同时操作系统在调度任务时因为线程较少，上下文切换的代价很低，这使得服务器能够有条不紊地处理请求，即使在大量连接的情况下，也不受线程上下文切换开销的影响。</p>
</blockquote>
<h1 id="Node-的问题"><a href="#Node-的问题" class="headerlink" title="Node 的问题"></a>Node 的问题</h1><ul>
<li>异步编程容易造成逻辑混乱，使用异步的方式控制任务顺序执行（Promise，async/await）</li>
<li>单线程的弱点（Web Workers，Nnigx 反向代理，负载均衡，开多个进程，绑定多个端口）<ul>
<li>无法利用多核 CPU</li>
<li>错误会引起整个应用退出，应用的健壮性存在问题</li>
<li>大量计算占用 CPU 导致无法继续调用异步 IO</li>
</ul>
</li>
</ul>
<h1 id="Node-的应用场景"><a href="#Node-的应用场景" class="headerlink" title="Node 的应用场景"></a>Node 的应用场景</h1><ul>
<li>擅长处理 I/O 密集型任务，不擅长处理 CPU 密集型任务。</li>
<li>高并发业务</li>
<li>长链接</li>
</ul>
<h1 id="非-I-O-的异步-API"><a href="#非-I-O-的异步-API" class="headerlink" title="非 I/O 的异步 API"></a>非 I/O 的异步 API</h1><ul>
<li>定时器</li>
<li>process.nextTick()</li>
<li>setImmediate()</li>
</ul>
<h1 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h1><h2 id="setTimeout-和-setInterval"><a href="#setTimeout-和-setInterval" class="headerlink" title="setTimeout()和 setInterval()"></a>setTimeout()和 setInterval()</h2><p>和浏览器中的 API 是一致的，分别用于单次和多次定时执行任务。</p>
<p>调用 setTimeout()或者 setInterval()创建的<strong>定时器对象</strong>会被插入到<strong>定时器观察者</strong>中，每次<strong>事件循环</strong>，定时器观察者都会取出定时器对象，检查是否超时，如果超时，就形成一个事件，调用对应的<strong>回调函数</strong></p>
<p>定时器是<strong>非精确</strong>的（在容忍范围内），如果某一次循环占用的时间较多，那么下次循环时，它也许已经超时很久了。</p>
<h1 id="process-nextTick"><a href="#process-nextTick" class="headerlink" title="process.nextTick()"></a>process.nextTick()</h1><p>立即异步执行一个任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(function () &#123;</span><br><span class="line">  // TODO</span><br><span class="line">&#125;, 0)</span><br></pre></td></tr></table></figure>
<p>setTimeout 较为浪费性能，在 node 环境下使用 process.nextTick()更高效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">process.nextTick(function () &#123;</span><br><span class="line">  // TODO</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>process.nextTick()只会将回调函数放入队列中，在下一轮事件循环时取出执行，时间复杂度为 O(1)，而定时器由于需要检索寻找符合条件的任务返回，时间复杂度为 O(lg(n))</p>
<h1 id="setImmediate"><a href="#setImmediate" class="headerlink" title="setImmediate()"></a>setImmediate()</h1><p>setImmediate()和 process.nextTick()方法类似，都是立即异步执行一个任务。</p>
<p>区别:</p>
<ol>
<li><p>优先级</p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E5%AF%B9%E8%A7%82%E5%AF%9F%E8%80%85%E7%9A%84%E6%A3%80%E6%9F%A5%E9%A1%BA%E5%BA%8F%E5%89%AF%E6%9C%AC.jpg" alt=""></p>
</li>
<li><p>process.nextTick()用数组实现用 1000 的长度限制，setImmediate()用链表实现没有长度限制</p>
</li>
<li><p>在 setImmediate 中，如果一个立即异步任务是被一个正在执行的回调排入队列的，则该立即异步任务直到下一次事件循环才会被触发。</p>
</li>
</ol>
<h1 id="谢谢！"><a href="#谢谢！" class="headerlink" title="谢谢！"></a>谢谢！</h1><ul>
<li><a href="http://www.ruanyifeng.com/blog/2013/10/event_loop.html" target="_blank" rel="noopener">什么是 Event Loop?</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-async/" target="_blank" rel="noopener">使用异步 I/O 大大提高应用程序的性能</a></li>
<li><a href="http://zhuanlan.zhihu.com/p/28527741" target="_blank" rel="noopener">C++ in Node.js 业务场景及开发实现 - crcrcry 的文章 - 知乎</a></li>
<li><a href="http://nodejs.cn/api/process.html#process_process_nexttick_callback_args" target="_blank" rel="noopener">node.js API 文档 process.nextTick(callback[, …args])</a></li>
<li><a href="http://nodejs.cn/api/timers.html#timers_setimmediate_callback_args" target="_blank" rel="noopener">node.js API 文档 setImmediate(callback[, …args])</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/19/ory editor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxc">
      <meta itemprop="description" content="前端/js/react/vue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴某某嗯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/19/ory editor/" itemprop="url">
                  ORY Editor入门指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-12-19 18:56:00" itemprop="dateCreated datePublished" datetime="2017-12-19T18:56:00+08:00">2017-12-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-05-14 19:48:03" itemprop="dateModified" datetime="2018-05-14T19:48:03+08:00">2018-05-14</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>因为工作需要借鉴了此编辑器，发现官方的教程有些过时了，而且有些地方有错误，所以特地翻译成了中文，并做了一点修正。</p>
<p>原git项目地址：<a href="https://github.com/ory/editor" target="_blank" rel="noopener">https://github.com/ory/editor</a></p>
</blockquote>
<p>[TOC]</p>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>欢迎来到ORY Editor指南。请注意，ORY Editor需要大量的ReactJS知识，构建工具如webpack以及ES6。</p>
<h2 id="示范"><a href="#示范" class="headerlink" title="示范"></a>示范</h2><p>眼见为实，所以让我们从一个演示开始！</p>
<p><img src="https://storage.googleapis.com/ory.am/inline-edit-lg.gif" alt="ORY编辑器演示"></p>
<p>这是<a href="https://editor.ory.am/" target="_blank" rel="noopener">示例程序</a>，可以自己尝试一下！</p>
<h2 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h2><p>现有的开源内容编辑解决方案有三个缺陷之一：</p>
<ol>
<li>不得不使用许多措施来防御XSS威胁。</li>
<li>使用编辑器的作者必须学习一些语法，如markdown，才能编写内容。这些基于文本的解决方案通常无法指定布局，并且不能制作复杂的结构（如表格布局）。</li>
<li>有前途的开源项目可能会遇到被维护者遗弃的问题，因为它可能只是别人用来打发空闲时间的项目。</li>
</ol>
<p>所以好的解决方案必须符合以下原则：</p>
<ol>
<li>状态是规范化的JSON对象，不涉及HTML，用来防止XSS。</li>
<li>这是一个可视化编辑器，不需要编程经验或特殊培训。</li>
<li>它由一家公司创建，减少了被遗弃的可能性。</li>
<li>基于可重复使用的React组件，它为开发人员、作者和设计人员提供了新的工作方式，能更轻松更好地创建更丰富的体验。</li>
<li>适配移动端。</li>
</ol>
<p>出于这些原则，作者制作了ORY Editor。</p>
<h2 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h2><p>ORY Editor主要是一个创建和修改布局的工具，核心是<code>Cell</code>和<code>Row</code>。布局与<a href="https://v3.bootcss.com/css/#grid" target="_blank" rel="noopener">bootstrap栅格布局</a>非常相似。</p>
<p>编辑器的最外层是<code>Editable</code>，一个<code>Editable</code>的示例性结构可能如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. Editable</span><br><span class="line">+-1. Container cell</span><br><span class="line">  +-1. Row</span><br><span class="line">  | +-1. Cell (text)</span><br><span class="line">  | |-2. Cell (parallax background image)</span><br><span class="line">  |   +-1. Row </span><br><span class="line">  |     +-1. Cell (image)</span><br><span class="line">  |     |-2. Cell (image)</span><br><span class="line">  |-2. Row</span><br><span class="line">  | +-1. Cell (image)</span><br><span class="line">  | |-2. Cell (image)</span><br></pre></td></tr></table></figure>
<p>有四种不同的数据类型：</p>
<ol>
<li><p><strong>Editable</strong>（结构树中的<code>1.</code>） - <code>Editable</code>是<code>Cell</code>和<code>Row</code>的容器。一个页面里可以有多个<code>Editable</code>，并且可以将<code>Cell</code>从一个<code>Editable</code>区域拖拽到另一个<code>Editable</code>区域。</p>
<p>​</p>
</li>
<li><p><strong>Container cell</strong>（结构树中的<code>1.1</code>） - <code>Container cell</code>是一个没有插件的<code>Cell</code>，它为<code>Editable</code>提供结构。这些<code>Container cell</code>在需要时自动生成，并在不再需要时自动删除。</p>
<p>​</p>
</li>
<li><p><strong>Content cell</strong>（结构树中的 <code>1.1.1</code>，<code>1.2.1</code>…） - <code>Content cell</code>格始终是树的一个叶子节点（它没有子节点），节点由<strong>内容插件</strong>定义（可由您编写或从npm下载）。内容插件通常是富文本，视频，音频，图片等等。</p>
<p>​</p>
</li>
<li><p><strong>Layout cell</strong>  - <code>Layout cell</code>包含、嵌套<code>Cell</code>和<code>Row</code>（容器，内容，布局）的列表。<code>Layout cell</code>的作用是，它给子节点一个布局样式（比如布局内所有文字都是红色）。布局是由<strong>布局插件</strong>定义的。<code>Layout cell</code>必须至少有一个子节点，否则<code>Layout cell</code>将被自动删除。</p>
</li>
</ol>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/content-cell.png" alt="内容单元"></p>
<center><em>带图片插件的Content cell</em></center>

<p><img src="http://oy1qb3tnj.bkt.clouddn.com/layout-cell.gif" alt="布局单元格"></p>
<center><em>具有可切换背景图像插件的Layout cell </em></center>



<p>网格系统很好地集成到了ORY Editor中。它负责一切的拖拽逻辑、调整大小、焦点检测等等。作为开发人员，主要使用<strong>内容插件</strong>和<strong>布局插件</strong>来扩展功能，只需编写接收<code>onChange</code>，<code>readOnly</code>，<code>state</code>（编辑器产生）的简单ReactJS 组件，完整的数据模型交给ORY Editor。在后面的章节中学习插件如何正确工作，插件的外观以及如何编写自己的插件。</p>
<h1 id="使用指南"><a href="#使用指南" class="headerlink" title="使用指南"></a>使用指南</h1><h2 id="核心"><a href="#核心" class="headerlink" title="核心"></a>核心</h2><p>ORY Editor的核心是<a href="https://www.npmjs.com/package/ory-editor-core" target="_blank" rel="noopener">ory-editor-core</a>。它包含创建和修改布局的逻辑，并负责处理插件。</p>
<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><p>ORY Editor使用Redux store来管理内部状态。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Editor <span class="keyword">from</span> <span class="string">'ory-editor-core'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> editor = <span class="keyword">new</span> Editor()</span><br></pre></td></tr></table></figure>
<p>当创建一个新的<code>Editor</code>实例，Redux store也被创建。因此，在应用程序生命周期中必须仅实例化一次<code>Editor</code>（<em>单例</em>模式）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Editor <span class="keyword">from</span> <span class="string">'ory-editor-core'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> editor = <span class="keyword">new</span> Editor()</span><br><span class="line"><span class="keyword">const</span> editor2 = <span class="keyword">new</span> Editor() <span class="comment">// 不要这样做！.</span></span><br></pre></td></tr></table></figure>
<h2 id="添加插件"><a href="#添加插件" class="headerlink" title="添加插件"></a>添加插件</h2><p>现在我们知道如何创建一个空的<code>Editor</code>。现在让我们加一些插件。我们将使用<em>ORY Editor资源库</em>提供的插件。我们称这些插件为“ory plugins”，因为它们是由官方编写和维护的。</p>
<p>让我们为初学者做一个图片插件。图片插件是一个简单的内容插件，允许您通过图片URL来添加图像，目前不支持上传图片。</p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/content-cell.png" alt="内容单元"></p>
<center><em>ory图像插件</em></center>

<p>要安装图片插件，我们使用NPM： <code>npm install ory-editor-plugins-image</code>。接下来，我们需要将它添加到我们的编辑器实例中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Editor <span class="keyword">from</span> <span class="string">'ory-editor-core'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> image <span class="keyword">from</span> <span class="string">'ory-editor-plugins-image'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'ory-editor-plugins-image/lib/index.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> editor = <span class="keyword">new</span> Editor(&#123;</span><br><span class="line">  plugins: &#123;</span><br><span class="line">    content: [image],</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>让我们从头到尾看下这段代码。首先，我们导入图片插件和它所需的CSS：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> image <span class="keyword">from</span> <span class="string">'ory-editor-plugins-image'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'ory-editor-plugins-image/lib/index.css'</span></span><br></pre></td></tr></table></figure>
<p>我们假设你正在运行带有能够导入CSS的插件。</p>
<p>接下来，我们创建编辑器实例，并通过构造函数传递图像内容插件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> editor = <span class="keyword">new</span> Editor(&#123;</span><br><span class="line">  plugins: &#123;</span><br><span class="line">    content: [image],</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>当然也可以选择在运行时（也就是在创建编辑器实例之后）添加/设置/删除布局和内容插件，如下所示。使用这些方法将强制重新渲染编辑器。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">editor.addContentPlugin(image)</span><br><span class="line">editor.removeContentPlugin(image)</span><br><span class="line">editor.setContentPlugins([image])</span><br></pre></td></tr></table></figure>
<h2 id="渲染"><a href="#渲染" class="headerlink" title="渲染"></a>渲染</h2><p>接下来，我们显然想渲染编辑器。从核心软件包（ory-editor-core）导出一个名为<code>Editable</code>的ReactJs组件。假设我们的HTML是这样：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"editable-1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"controls"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在这种情况下，JavaScript代码如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Editor, &#123; Editable &#125; <span class="keyword">from</span> <span class="string">'ory-editor-core'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> image <span class="keyword">from</span> <span class="string">'ory-editor-plugins-image'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'ory-editor-plugins-image/lib/index.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> editor = <span class="keyword">new</span> Editor(&#123;</span><br><span class="line">  plugins: &#123;</span><br><span class="line">    content: [image]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ReactDOM.render((</span><br><span class="line">  &lt;Editable editor=&#123;editor&#125; /&gt;</span><br><span class="line">), <span class="built_in">document</span>.getElementById(<span class="string">'editable-1'</span>))</span><br></pre></td></tr></table></figure>
<p>我们只需要渲染<code>Editable</code>组件并传递<code>editor</code>实例。但这里什么都不会发生，这是因为没有可供呈现的内容。</p>
<h3 id="创建一个空的状态"><a href="#创建一个空的状态" class="headerlink" title="创建一个空的状态"></a>创建一个空的状态</h3><p>通过核心导出一个名为<code>createEmptyState</code>的方法创建一个空state。结果是一个JSON对象，其中包含一个唯一的ID。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createEmptyState &#125; <span class="keyword">from</span> <span class="string">'ory-editor-core'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> editable = createEmptyState()</span><br><span class="line"><span class="built_in">console</span>.log(editable.id)</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    "id": "258ef48a-9668-43c5-a771-d279f014a3a4", </span></span><br><span class="line"><span class="comment">//    "cells": [ ]</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br></pre></td></tr></table></figure>
<p>把这个添加到上面的代码中，我们得到：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Editor, &#123; Editable, createEmptyState &#125; <span class="keyword">from</span> <span class="string">'ory-editor-core'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> image <span class="keyword">from</span> <span class="string">'ory-editor-plugins-image'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'ory-editor-plugins-image/lib/index.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> editable = createEmptyState()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> editor = <span class="keyword">new</span> Editor(&#123;</span><br><span class="line">  plugins: &#123;</span><br><span class="line">    content: [image]</span><br><span class="line">  &#125;,</span><br><span class="line">  editables: [editable],</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ReactDOM.render((</span><br><span class="line">  &lt;Editable</span><br><span class="line">    editor=&#123;editor&#125;</span><br><span class="line">    id=&#123;editable.id&#125;</span><br><span class="line">  /&gt;</span><br><span class="line">), <span class="built_in">document</span>.getElementById(<span class="string">'editable-1'</span>))</span><br></pre></td></tr></table></figure>
<p>请注意，必需添加<code>id={editable.id}</code>到<code>&lt;Editable&gt;</code>，<code>Editable</code>会通过id与editable中的id对比来判断数据是否属于该<code>Editable</code>，我们也可以自定义id，只要数据中的id也对上：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.render((</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;div className=<span class="string">"left"</span>&gt;</span><br><span class="line">      &lt;Editable editor=&#123;editor&#125; id=<span class="string">"1"</span> /&gt;  </span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    &lt;div className="right"&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Editable editor=&#123;editor&#125; id="2" /</span>&gt;    </span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line">), <span class="built_in">document</span>.getElementById(<span class="string">'editable-1'</span>))</span><br></pre></td></tr></table></figure>
<h2 id="保存和加载"><a href="#保存和加载" class="headerlink" title="保存和加载"></a>保存和加载</h2><p>现在你已经知道了如何渲染一个编辑器并且用一个空的state来填充它，让我们来看看如何保存数据和加载数据。</p>
<p>可以使用<code>onChange</code>属性来捕获<code>&lt;Editable&gt;</code>的更改。<code>onChange</code>的参数是一个新的editable，包含了整个<code>Editable</code>里所有的state的序列化值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.render((</span><br><span class="line">  &lt;Editable</span><br><span class="line">    editor=&#123;editor&#125;</span><br><span class="line">    id=<span class="string">"1"</span></span><br><span class="line">    onChange=&#123;(editable) =&gt; &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(editable)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">  /&gt;</span><br><span class="line">), <span class="built_in">document</span>.getElementById(<span class="string">'editable-1'</span>))</span><br></pre></td></tr></table></figure>
<p>它仅包含原始值（string, number, array, map），并且它可以序列化为JSON。</p>
<p>比方说，你有一个叫<code>saveToBackend</code>的函数用来存储数据到数据库。你可以在onChange调用这个方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.render((</span><br><span class="line">  &lt;Editable</span><br><span class="line">    editor=&#123;editor&#125;</span><br><span class="line">    id=<span class="string">"1"</span></span><br><span class="line">    onChange=&#123;(editable) =&gt; &#123;</span><br><span class="line">      saveToBackend(editable)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">  /&gt;</span><br><span class="line">), <span class="built_in">document</span>.getElementById(<span class="string">'editable-1'</span>))</span><br></pre></td></tr></table></figure>
<p>要加载内容，只需将其传递给构造函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> editable = loadFromBackend() <span class="comment">// just an example</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> editor = <span class="keyword">new</span> Editor(&#123;</span><br><span class="line">  plugins: &#123;</span><br><span class="line">    content: [image]</span><br><span class="line">  &#125;,</span><br><span class="line">  editables: [editable],</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">or use the <span class="string">`trigger`</span> API.</span><br><span class="line"></span><br><span class="line">​<span class="string">``</span><span class="string">`jsx</span></span><br><span class="line"><span class="string">// const editor = new Editor( ...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">const editable = loadFromBackend() // 只是一个例子，用来取序列化的state数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">editor.editable.update(editable) // 如果尚未存在，则添加内容，如果已在store存在，则更新</span></span><br></pre></td></tr></table></figure>
<h1 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h1><h2 id="ReactJS示例"><a href="#ReactJS示例" class="headerlink" title="ReactJS示例"></a>ReactJS示例</h2><p>在本节中，我们将创建一个使用ORY Editor的简单react app。请确保您的系统上安装了<a href="https://nodejs.org/en/" target="_blank" rel="noopener">node.js</a></p>
<p>目前，ORY Editor只能通过npm使用，而且在ReactJS环境下效果最好。</p>
<h3 id="ReactJS"><a href="#ReactJS" class="headerlink" title="ReactJS"></a>ReactJS</h3><p>首先创建一个ReactJS应用程序。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> npm i -g create-react-app</span><br><span class="line"><span class="meta">$</span> create-react-app .</span><br></pre></td></tr></table></figure>
<p>使用npm安装ory-editor：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> npm i --save ory-editor</span><br></pre></td></tr></table></figure>
<p>接下来，打开文件<em>src / components / App.js</em>添加ORY Editor：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载编辑器核心</span></span><br><span class="line"><span class="keyword">import</span> Editor, &#123; Editable, createEmptyState &#125; <span class="keyword">from</span> <span class="string">'ory-editor-core'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'ory-editor-core/lib/index.css'</span> <span class="comment">// we also want to load the stylesheets</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载UI组件（悬浮在左侧的添加编辑按钮等），你也可以使用自己的实现的，这里使用的是官方的组件</span></span><br><span class="line"><span class="keyword">import</span> &#123; Trash, DisplayModeToggle, Toolbar &#125; <span class="keyword">from</span> <span class="string">'ory-editor-ui'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'ory-editor-ui/lib/index.css'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载插件:</span></span><br><span class="line"><span class="keyword">import</span> slate <span class="keyword">from</span> <span class="string">'ory-editor-plugins-slate'</span> <span class="comment">//  富文本内容插件</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'ory-editor-plugins-slate/lib/index.css'</span> <span class="comment">// Stylesheets for the rich text area plugin</span></span><br><span class="line"><span class="keyword">import</span> parallax <span class="keyword">from</span> <span class="string">'ory-editor-plugins-parallax-background'</span> <span class="comment">// 视差背景布局插件</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'ory-editor-plugins-parallax-background/lib/index.css'</span> <span class="comment">// Stylesheets for parallax background images</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'react-tap-event-plugin'</span>)() <span class="comment">// react-tap-event-plugin is required by material-ui which is used by ory-editor-ui so we need to call it here</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义哪些插件是我们要用的，这里我们只使用了slate和parallax两个插件，所以只加载这两个</span></span><br><span class="line"><span class="keyword">const</span> plugins = &#123;</span><br><span class="line">  content: [slate()], <span class="comment">// 定义内容插件</span></span><br><span class="line">  layout: [parallax(&#123; <span class="attr">defaultPlugin</span>: slate() &#125;)] <span class="comment">// 定义布局插件</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建空的editable，表示编辑器中内容为空</span></span><br><span class="line"><span class="keyword">const</span> content = createEmptyState()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例化编辑器</span></span><br><span class="line"><span class="keyword">const</span> editor = <span class="keyword">new</span> Editor(&#123;</span><br><span class="line">  plugins,</span><br><span class="line">  <span class="comment">// 通过editables传递数据，可以有多个content，表示多个数据源，Editor会使用id来判断是否渲染</span></span><br><span class="line">  editables: [content],</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;<span class="comment">/* 编辑器内容 */</span>&#125;</span><br><span class="line">        &lt;Editable editor=&#123;editor&#125; id=&#123;content.id&#125;/&gt;</span><br><span class="line"></span><br><span class="line">        &#123;<span class="comment">/* UI组件 */</span>&#125;</span><br><span class="line">        &lt;Trash editor=&#123;editor&#125;/&gt;</span><br><span class="line">        &lt;DisplayModeToggle editor=&#123;editor&#125;/&gt;</span><br><span class="line">        &lt;Toolbar editor=&#123;editor&#125;/&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default App;</span></span><br></pre></td></tr></table></figure>
<p>就是这样，恭喜！你现在应该看到这样的东西：</p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/30C0C14A-2AD4-4F8F-A13B-FA363B8764F8.png" alt="示例应用"></p>
<p>这里的Text和Parallax Background就是刚刚在plugins中添加的内容插件（slate）和布局插件（parallax）</p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/8E9157B2-3159-4126-84DE-7401C437E198.png" alt="示例应用"></p>
<h2 id="写插件"><a href="#写插件" class="headerlink" title="写插件"></a>写插件</h2><h3 id="编写一个内容插件"><a href="#编写一个内容插件" class="headerlink" title="编写一个内容插件"></a>编写一个内容插件</h3><p>你可以很容易地编写自己的插件。插件有两个部分，一个是插件的定义，另一个是ReactJS组件。最小的插件定义如下所示</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// You are obviously not limited to material-ui, but we really enjoy</span></span><br><span class="line"><span class="comment">// the material-ui svg icons!</span></span><br><span class="line"><span class="keyword">import</span> StarIcon <span class="keyword">from</span> <span class="string">'material-ui/svg-icons/toggle/star'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入要使用的ReactJS组件</span></span><br><span class="line"><span class="keyword">import</span> InputTextField <span class="keyword">from</span> <span class="string">'./Component'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  Component: InputTextField,</span><br><span class="line">  IconComponent: <span class="xml"><span class="tag">&lt;<span class="name">StarIcon</span> /&gt;</span>,</span></span><br><span class="line"><span class="xml">  name: 'example/content/input-text-field',</span></span><br><span class="line"><span class="xml">  version: '0.0.1',</span></span><br><span class="line"><span class="xml">  text: 'Input Text Field'</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>一个简单的ReactJS组件可以是这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// A callback function for the input field</span></span><br><span class="line"><span class="keyword">const</span> onInput = <span class="function">(<span class="params">onChange</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Dispatch the onChange action with the new value</span></span><br><span class="line">    onChange(&#123;</span><br><span class="line">      value: e.target.value</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> InputTextField = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 这里的state、readOnly和onChan是必须的</span></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    state: &#123; value = <span class="string">''</span> &#125;,</span><br><span class="line">    readOnly,</span><br><span class="line">    onChange</span><br><span class="line">  &#125; = props</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果readOnly为false，说明编辑器处于可编辑状态</span></span><br><span class="line">  <span class="keyword">if</span> (!readOnly) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=<span class="string">"my-plugin"</span>&gt;</span><br><span class="line">        &lt;input</span><br><span class="line">          type=<span class="string">"text"</span></span><br><span class="line">          onChange=&#123;onInput(onChange)&#125; value=&#123;value&#125; /&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  /</span><span class="regexp">/ If we are not in edit mode, remove the input field</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;div className="my-plugin"&gt;</span></span><br><span class="line"><span class="regexp">      &#123;value&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> InputTextField</span><br></pre></td></tr></table></figure>
<p>当然，还有更多的设置和回调可用。欢迎查看关于此主题的API文档！</p>
<p>最后，在APP.js中，启用刚写的内容插件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> testInput <span class="keyword">from</span> <span class="string">'./component/testInput'</span>		<span class="comment">// 引入刚刚写的内容插件</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> plugins = &#123; </span><br><span class="line">  content: [slate(), image, testInput], <span class="comment">// 定义内容插件</span></span><br><span class="line">  layout: [parallax(&#123; <span class="attr">defaultPlugin</span>: slate() &#125;)] <span class="comment">// 定义布局插件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来看看效果吧！</p>
<p>在列表中，已经可以看到刚刚添加的<strong>内容插件</strong></p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/1513832631360.jpg" alt=""></p>
<p>将<strong>内容插件</strong>拖到编辑器中，在编辑模式下能看到input输入框</p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/1513832349623.jpg" alt=""></p>
<p><strong>注：</strong></p>
<p>浏览器的控制台可能会报一个错误</p>
<blockquote>
<p> Warning: Received <code>true</code> for a non-boolean attribute <code>autoCorrect</code>.</p>
</blockquote>
<p>这个是因为react版本的问题，在package.json中从把”react”: “^16.2.0”换回”react”: “^15.4.0”, “react-dom”: “^15.4.0”, …后问题解决，具体原因还不知道。</p>
<p>参考:<a href="https://github.com/ory/editor/issues/494" target="_blank" rel="noopener">issues/494</a></p>
<h3 id="编写一个布局插件"><a href="#编写一个布局插件" class="headerlink" title="编写一个布局插件"></a>编写一个布局插件</h3><p>布局插件有两个部分，一个插件定义和一个ReactJS组件。最小的布局插件定义如下所示</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// You are obviously not limited to material-ui, but we really enjoy</span></span><br><span class="line"><span class="comment">// the material-ui svg icons!</span></span><br><span class="line"><span class="keyword">import</span> CropSquare <span class="keyword">from</span> <span class="string">'material-ui/svg-icons/image/crop-square'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 样式定义</span></span><br><span class="line"><span class="keyword">const</span> BlackBorderPlugin = <span class="function">(<span class="params">&#123; children &#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;div style=&#123;&#123; <span class="attr">border</span>: <span class="string">'1px solid black'</span>, <span class="attr">padding</span>: <span class="string">'16px'</span>, <span class="attr">height</span>: <span class="string">'300px'</span>&#125;&#125;&gt;</span><br><span class="line">    &#123;children&#125;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">)</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default &#123;</span></span><br><span class="line"><span class="regexp">  Component: BlackBorderPlugin,</span></span><br><span class="line"><span class="regexp">  IconComponent: &lt;CropSquare /</span>&gt;,</span><br><span class="line">  name: <span class="string">'example/layout/black-border'</span>,</span><br><span class="line">  version: <span class="string">'0.0.1'</span>,</span><br><span class="line">  text: <span class="string">'Black border'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是<strong>布局插件</strong>必须至少有一个子节点，否则<strong>布局插件</strong>将被自动删除，所以要加上默认的子节点。</p>
<p>修改export为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _uuid <span class="keyword">from</span> <span class="string">'uuid'</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (child) =&gt; &#123;</span><br><span class="line">  <span class="keyword">var</span> defaultPlugin = child.defaultPlugin;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    Component: BlackBorderPlugin,</span><br><span class="line">    IconComponent: <span class="xml"><span class="tag">&lt;<span class="name">CropSquare</span> /&gt;</span>,</span></span><br><span class="line"><span class="xml">    name: 'example/layout/black-border',</span></span><br><span class="line"><span class="xml">    version: '0.0.1',</span></span><br><span class="line"><span class="xml">    text: 'Black border',</span></span><br><span class="line"><span class="xml">    createInitialChildren: function createInitialChildren() &#123;</span></span><br><span class="line"><span class="xml">      return &#123;</span></span><br><span class="line"><span class="xml">        id: (0, _uuid.v4)(),</span></span><br><span class="line"><span class="xml">        rows: [&#123;</span></span><br><span class="line"><span class="xml">          id: (0, _uuid.v4)(),</span></span><br><span class="line"><span class="xml">          cells: [&#123;</span></span><br><span class="line"><span class="xml">            content: &#123;</span></span><br><span class="line"><span class="xml">              plugin: defaultPlugin,</span></span><br><span class="line"><span class="xml">              state: defaultPlugin.createInitialState()</span></span><br><span class="line"><span class="xml">            &#125;,</span></span><br><span class="line"><span class="xml">            id: (0, _uuid.v4)()</span></span><br><span class="line"><span class="xml">          &#125;]</span></span><br><span class="line"><span class="xml">        &#125;]</span></span><br><span class="line"><span class="xml">      &#125;;</span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>其中createInitialChildren返回的对象格式不能随意修改，否则<code>Editor</code>可能无法正常识别，而导致错误</p>
<p>最后，在APP.js中，添加<strong>布局插件</strong>的地方传入一个默认的<strong>内容组件</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> testLayout <span class="keyword">from</span> <span class="string">'./component/testLayout'</span>		<span class="comment">// 引入刚刚写的布局插件</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> plugins = &#123; </span><br><span class="line">  content: [slate(), image, testInput], <span class="comment">// 定义内容插件</span></span><br><span class="line">  layout: [parallax(&#123; <span class="attr">defaultPlugin</span>: slate() &#125;), testLayout(&#123;<span class="attr">defaultPlugin</span>: slate()&#125;)] <span class="comment">// 定义布局插件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来看看效果吧！</p>
<p>在列表中，已经可以看到刚刚添加的<strong>布局插件</strong></p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/1513832864579.jpg" alt=""></p>
<p>将<strong>布局插件</strong>拖到编辑器中，在编辑模式下能看到样式为<code>border: &#39;1px solid black&#39;, padding: &#39;16px&#39;, height: &#39;300px&#39;</code>的布局，以及嵌套在其中的默认子组件（富文本内容插件），在移动模式下，将这个子组件删除，整个<strong>布局插件</strong>就会自动删除。</p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/1513832905392.jpg" alt=""></p>
<h2 id="呈现HTML"><a href="#呈现HTML" class="headerlink" title="呈现HTML"></a>呈现HTML</h2><p>该<code>ory-editor-renderer</code>软件包提供了一个轻量级的HTML渲染器模块，通过这个模块渲染出展示用的html页面。您可以将其用于服务器端渲染或客户端渲染</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; HTMLRenderer &#125; <span class="keyword">from</span> <span class="string">'ory-editor-renderer'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> content = getEditorContent(id)	 <span class="comment">// 获取编辑器的数据，这只是一个例子</span></span><br><span class="line"><span class="keyword">const</span> state = &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="keyword">const</span> plugins = &#123;</span><br><span class="line">  layout: [<span class="comment">/* ... */</span>],		<span class="comment">// 布局插件</span></span><br><span class="line">  content: [<span class="comment">/* ... */</span>]		<span class="comment">// 内容插件</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> element = <span class="built_in">document</span>.getElementById(<span class="string">'editable'</span>)</span><br><span class="line">ReactDOM.render((</span><br><span class="line">  &lt;HTMLRenderer state=&#123;content[<span class="number">0</span>]&#125; plugins=&#123;plugins&#125;/&gt;</span><br><span class="line">), element)</span><br></pre></td></tr></table></figure>
<h2 id="保存和恢复编辑器内容"><a href="#保存和恢复编辑器内容" class="headerlink" title="保存和恢复编辑器内容"></a>保存和恢复编辑器内容</h2><p>使用<code>onChange</code>回调来获取编辑器state的副本，可以用来持久化数据（存到数据库或其他方式保存数据）。之后这个被持久化的state可以加载到编辑器中被再次编辑，或者被<code>ory-editor-renderer</code>包渲染成HTML。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> Editor, &#123; Editable, createEmptyState &#125; <span class="keyword">from</span> <span class="string">'ory-editor-core'</span></span><br><span class="line"><span class="keyword">import</span> slate <span class="keyword">from</span> <span class="string">'ory-editor-plugins-slate'</span> <span class="comment">// The rich text area plugin</span></span><br><span class="line"><span class="keyword">import</span> &#123; Trash, DisplayModeToggle, Toolbar &#125; <span class="keyword">from</span> <span class="string">'ory-editor-ui'</span></span><br><span class="line"><span class="keyword">const</span> EditorPlugins = &#123;</span><br><span class="line">  content: [slate()],</span><br><span class="line">  layout: [<span class="comment">/* ... */</span>],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">saveToDatabase</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="string">'/my/save/url'</span>, &#123; <span class="attr">method</span>: <span class="string">'POST'</span>, <span class="attr">body</span>: state &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyEditor</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    componentWillMount() &#123;</span><br><span class="line">        <span class="keyword">this</span>.editorState = <span class="keyword">this</span>.props.content || createEmptyState();</span><br><span class="line">        <span class="keyword">this</span>.editor = <span class="keyword">new</span> Editor(&#123; EditorPlugins, <span class="attr">editables</span>: [content] &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          &lt;div className=<span class="string">"my-editor"</span>&gt;</span><br><span class="line">            &lt;toolbar&gt;</span><br><span class="line">              &lt;button onClick=&#123;() =&gt; saveToDatabase(<span class="keyword">this</span>.editorState)&#125;&gt;Save&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>toolbar&gt;</span><br><span class="line">            &lt;Editable editor=&#123;editor&#125; id=&#123;content.id&#125; onChange=&#123;state =&gt; (<span class="keyword">this</span>.editorState = state)&#125; /&gt;</span><br><span class="line">            &lt;Trash editor=&#123;editor&#125;/&gt;</span><br><span class="line">            &lt;DisplayModeToggle editor=&#123;editor&#125;/&gt;</span><br><span class="line">            &lt;Toolbar editor=&#123;editor&#125;/&gt;</span><br><span class="line">          &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>然后可以通过执行如下操作来获取状态：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; HTMLRenderer &#125; <span class="keyword">from</span> <span class="string">'ory-editor-renderer'</span></span><br><span class="line"><span class="keyword">import</span> &#123; createEmptyState &#125; <span class="keyword">from</span> <span class="string">'ory-editor-core'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyEditorRenderer</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    componentWillMount() &#123;</span><br><span class="line">        <span class="keyword">this</span>.plugins = &#123; <span class="comment">//&#125;;</span></span><br><span class="line">        <span class="keyword">this</span>.setState(&#123; <span class="attr">contents</span>: createEmptyState() &#125;);</span><br><span class="line">        fetch(<span class="string">'/my/save/url'</span>).then(<span class="function">(<span class="params">savedState</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.setState(&#123; <span class="attr">contents</span>: savedState &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div className=<span class="string">"my-editor"</span>&gt;</span><br><span class="line">                &lt;HTMLRenderer state=&#123;<span class="keyword">this</span>.state.contents&#125; plugins=&#123;EditorPlugins&#125; /&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const element = document.getElementById('editable')</span></span><br><span class="line"><span class="regexp">ReactDOM.render((</span></span><br><span class="line"><span class="regexp">  &lt;MyEditorRenderer /</span>&gt;</span><br><span class="line">), element)</span><br></pre></td></tr></table></figure>
<p>下面内容的作用还不知道，就先放出原文</p>
<h2 id="Handling-native-drag-events"><a href="#Handling-native-drag-events" class="headerlink" title="Handling native drag events"></a>Handling native drag events</h2><p>The ORY Editor is capable of handling native drag and drop events. Native events include dragging of links, text, and images. Native drag support can be enabled by writing a <code>NativePlugin</code> and passing it during instantiation. In this example, we will use the default plugin, and take a look at how you can create your own later.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import native from &apos;ory-editor-plugins-default-native&apos;</span><br><span class="line"></span><br><span class="line">const editor = new Editor(&#123;</span><br><span class="line">  plugins: &#123;</span><br><span class="line">   layout: [],</span><br><span class="line">   content: [],</span><br><span class="line">   native</span><br><span class="line"> &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>If native is undefined or null, native dragging wil be disabled. This is the default setting.</p>
<p>Writing a native plugin is like writing a content or layout plugin. The only difference is that our native plugin must be wrapped in a factory that receives three arguments - <code>hover</code>, <code>monitor</code>, and <code>component</code>. Hover is the cell or row that is currently being hovered. Monitor is the <a href="https://react-dnd.github.io/react-dnd/docs-drop-target-monitor.html" target="_blank" rel="noopener">DropTargetMonitor</a>coming from react-dnd and <code>component</code> is the React component of the cell or row that is currently being hovered.</p>
<p>In sum, an exemplary plugin looks like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import React from &apos;react&apos;</span><br><span class="line"></span><br><span class="line">const Native = () =&gt; &lt;div&gt;native&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">export default (hover, monitor, component) =&gt; (&#123;</span><br><span class="line">  Component: Native,</span><br><span class="line">  name: &apos;my-native-plugin&apos;,</span><br><span class="line">  version: &apos;0.0.1&apos;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Because this plugin is wrapped in a factory, we are able to modify its behaviour based on the properties we receive. One such example would be to add the item’s data to the initial state for later use.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">export default (hover, monitor, component) =&gt; (&#123;</span><br><span class="line">  // ...</span><br><span class="line">  createInitialState: () =&gt; (&#123;</span><br><span class="line">    item: monitor.getItem()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Per default, the editor assumes that dropping the native element creates a content cell. To change this behaviour, use the key <code>type</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export default (hover, monitor, component) =&gt; (&#123;</span><br><span class="line">  // ...</span><br><span class="line">  type: &apos;layout&apos;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h1><h2 id="基础包"><a href="#基础包" class="headerlink" title="基础包"></a>基础包</h2><h2 id="ory-editor-core"><a href="#ory-editor-core" class="headerlink" title="ory-editor-core"></a><a href="https://www.npmjs.com/package/ory-editor-core" target="_blank" rel="noopener">ory-editor-core</a></h2><p>这个包是ORY Editor的核心。它包含创建和修改布局的逻辑，并负责处理插件。</p>
<h2 id="ory-editor-ui"><a href="#ory-editor-ui" class="headerlink" title="ory-editor-ui"></a><a href="https://www.npmjs.com/package/ory-editor-ui" target="_blank" rel="noopener">ory-editor-ui</a></h2><p>包含基于<a href="https://github.com/callemall/material-ui" target="_blank" rel="noopener">callemall / material-ui的</a> 的UI React组件 。虽然不是必须使用它们，但它们提供了一个简单的方法来开始使用ORY Editor。</p>
<h2 id="ory-editor-renderer"><a href="#ory-editor-renderer" class="headerlink" title="ory-editor-renderer"></a><a href="https://www.npmjs.com/package/ory-editor-renderer" target="_blank" rel="noopener">ory-editor-renderer</a></h2><p>包含ORY Editor的渲染组件，目前只支持HTML渲染，负责将数据输出为静态HTML。</p>
<h2 id="内容插件"><a href="#内容插件" class="headerlink" title="内容插件"></a>内容插件</h2><h3 id="ory-editor-plugins-slate"><a href="#ory-editor-plugins-slate" class="headerlink" title="ory-editor-plugins-slate"></a><a href="https://www.npmjs.com/package/ory-editor-plugins-slate" target="_blank" rel="noopener">ory-editor-plugins-slate</a></h3><p>创建和修改富文本，并针对ORY Editor进行了优化</p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/text-editing-plugin.gif" alt="Text editing plugin"></p>
<h3 id="ory-editor-plugins-image"><a href="#ory-editor-plugins-image" class="headerlink" title="ory-editor-plugins-image"></a><a href="https://www.npmjs.com/package/ory-editor-plugins-image" target="_blank" rel="noopener">ory-editor-plugins-image</a></h3><p>通过URL添加图片，不支持上传。</p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/image-plugin.gif" alt="Image plugin"></p>
<h3 id="ory-editor-plugins-video"><a href="#ory-editor-plugins-video" class="headerlink" title="ory-editor-plugins-video"></a><a href="https://www.npmjs.com/package/ory-editor-plugins-video" target="_blank" rel="noopener">ory-editor-plugins-video</a></h3><p>通过URL添加视频。</p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/video-plugin.gif" alt="Video plugin"></p>
<h3 id="ory-editor-plugins-spacer"><a href="#ory-editor-plugins-spacer" class="headerlink" title="ory-editor-plugins-spacer"></a><a href="https://www.npmjs.com/package/ory-editor-plugins-spacer" target="_blank" rel="noopener">ory-editor-plugins-spacer</a></h3><p>创建一个空的固定高度的<code>Cell</code></p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/spacer-plugin.gif" alt="Spacer plugin"></p>
<h2 id="内容插件-1"><a href="#内容插件-1" class="headerlink" title="内容插件"></a>内容插件</h2><h3 id="ory-editor-plugins-parallax-background"><a href="#ory-editor-plugins-parallax-background" class="headerlink" title="ory-editor-plugins-parallax-background"></a><a href="https://www.npmjs.com/package/ory-editor-plugins-parallax-background" target="_blank" rel="noopener">ory-editor-plugins-parallax-background</a></h3><p>添加一个视差背景图像作为背景</p>
<p><img src="http://oy1qb3tnj.bkt.clouddn.com/parallax-background.gif" alt="Spacer plugin"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/27/满意度问卷调查项目总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxc">
      <meta itemprop="description" content="前端/js/react/vue">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吴某某嗯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/27/满意度问卷调查项目总结/" itemprop="url">
                  满意度问卷调查项目总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-11-27 14:42:47" itemprop="dateCreated datePublished" datetime="2017-11-27T14:42:47+08:00">2017-11-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-07-12 23:52:59" itemprop="dateModified" datetime="2018-07-12T23:52:59+08:00">2018-07-12</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="项目总体描述"><a href="#项目总体描述" class="headerlink" title="项目总体描述"></a>项目总体描述</h2><p>&emsp;&emsp;满意度调查项目总体需求比较简单，使用了 vue 的 vux 组件库，整体使用下来非常方便，虽然说本次需求中问卷的题目是固定的，但是为了未来的复用性考虑，还是将整个问卷作为可配置来开发，后来发现整个决定很大程度上减少了开发的时间。</p>
<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>&emsp;&emsp;项目 1.0 版本在 11 月 25 日正式上线，在本次项目中，我负责微信端的开发，页面包括：</p>
<ol>
<li>登录界面，主要工作为按照设计制作页面，制作登录功能</li>
<li>问卷页面，主要功能为填写问卷和提交答案，问题类型分为四种：<ol>
<li>单选</li>
<li>多选（其他选项上需要一个输入框输入详细原因）</li>
<li>打分</li>
<li>填空</li>
</ol>
</li>
</ol>
<p>&emsp;&emsp;其他功能：</p>
<ul>
<li>跳转：选择某一选项跳转到某一道具体的题目上，若没配置，则默认下一题</li>
<li>显示控制：未被跳转到的题目保持折叠状态</li>
<li>必填控制：遇到选填题时自动显示下一题</li>
</ul>
<ol start="3">
<li>结果页面，主要功能为按照设计制作页面，显示抽奖号</li>
</ol>
<h3 id="原型"><a href="#原型" class="headerlink" title="原型"></a>原型</h3><p><img src="http://oy1qb3tnj.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20171113092756.jpg" alt="需求图"></p>
<h2 id="关于技术"><a href="#关于技术" class="headerlink" title="关于技术"></a>关于技术</h2><p>&emsp;&emsp;这次项目使用 vue 框架，因为以前有使用过，所以总体上手比较快，vux 组件库简单易用，非常适合移动端开发。</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><h3 id="一、题目列表设计"><a href="#一、题目列表设计" class="headerlink" title="一、题目列表设计"></a>一、题目列表设计</h3><p>&emsp;&emsp;需求总流程很简单，主要难点集中在如何设计一个可配置的问卷。</p>
<h4 id="1-总结构"><a href="#1-总结构" class="headerlink" title="1. 总结构"></a>1. 总结构</h4><p><img src="http://oy1qb3tnj.bkt.clouddn.com/%E9%97%AE%E5%8D%B7%E8%B0%83%E6%9F%A5.png" alt="结构"></p>
<h4 id="2-问卷数据的-json-结构"><a href="#2-问卷数据的-json-结构" class="headerlink" title="2. 问卷数据的 json 结构"></a>2. 问卷数据的 json 结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">answer: [</span><br><span class="line">    &#123;</span><br><span class="line">        questionId: &apos;&apos;,     // 问题id</span><br><span class="line">        optionsList: [],    // 答案选项id（单选和多选）</span><br><span class="line">        optionContent: &apos;&apos;   // 保存其他选项的详细内容（多选）</span><br><span class="line">        answerContent: &apos;&apos;,  // 保存字符串（文字和打分）</span><br><span class="line">        otherId: &apos;&apos;         // 其他这个选项的id（多选）</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">]</span><br><span class="line">question: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;questionId&quot;: 4,        // 问题id</span><br><span class="line">        &quot;questionType&quot;: &quot;&quot;,    // 问题类型（0:单选；1:多选 2:打分；3:填空）</span><br><span class="line">        &quot;questionNo&quot;: 4,        // 问题在问卷中的题号</span><br><span class="line">        &quot;questionName&quot;: &quot;&quot;,     // 问题的标题</span><br><span class="line">        &quot;isRequired&quot;: &quot;1&quot;,      // 问题是否为必选</span><br><span class="line">        &quot;remark&quot;: null,         // 备注（文字题中用于placeholder）</span><br><span class="line">        &quot;cateId&quot;: 1,            // 问题主题id</span><br><span class="line">        &quot;scheduleId&quot;: 0,        // 问卷id</span><br><span class="line">        &quot;optionsList&quot;: [        // 问题选项列表（单选和多选）</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;optionId&quot;: 6,          // 选项id</span><br><span class="line">                &quot;questionId&quot;: 4,        // 问题id</span><br><span class="line">                &quot;optionContent&quot;: &quot;&quot;,    // 选项内容  </span><br><span class="line">                &quot;isOther&quot;: &quot;0&quot;,         // 是否为其他项（多选）</span><br><span class="line">                &quot;remark&quot;: null,         // 备注</span><br><span class="line">                &quot;optionNo&quot;: 1,          // 选项在问题中的编号</span><br><span class="line">                &quot;linkQuestionId&quot;: null  // 选择后跳转到问题id</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        ],</span><br><span class="line">        &quot;optionScore&quot;: &#123;        // 打分题配置</span><br><span class="line">            &quot;optionScoreId&quot;: 30,        // 分数选项id</span><br><span class="line">            &quot;questionId&quot;: 78,           // 问题id</span><br><span class="line">            &quot;scoreMin&quot;: 1,              // 最低分</span><br><span class="line">            &quot;scoreMax&quot;: 10,             // 最高分</span><br><span class="line">            &quot;scoreLimit&quot;: 6,            // 分界线</span><br><span class="line">            &quot;linkQuestionId&quot;: 11        // 大于分界线跳转到问题id</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;通过分析需求，可以看出题目的跳转和选项相关，所以数据库中把控制跳转的的字段放在问题的选项中（optionsList 或 optionScore）。此外，保留了很多可配置的字段，为了后面题目发生修改时能快速调整。</p>
<h4 id="3-问卷生成"><a href="#3-问卷生成" class="headerlink" title="3. 问卷生成"></a>3. 问卷生成</h4><p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-7-12/19103424.jpg" alt=""></p>
<p>&emsp;&emsp;问卷是由 question 数组循环生成，在 question 组件中通过判断 questionType 生成不同的类型的题目，这样做的是为了把每个问题中公共的部分（保存答案，跳转事件，生成题目标题，控制显示等）放在 question 组件中处理。这样如果以后有新的题目类型，只需要在 question 组件中添加即可。</p>
<p><img src="http://wx-picture.oss-cn-hangzhou.aliyuncs.com/18-7-12/61431683.jpg" alt=""></p>
<p>&emsp;&emsp;在题目修改答案的时候保持单向的数据流，这样页面中每个样式的变化都是有迹可循的，发生错误时不会无从下手，并且保证页面显示和内存中的值保存一致。为了方便后端的解析入库，不同类型题目的 answer 对象保存一致，这就需要在 question 组件中对 answer 对象进行拆解和组装。此外，question 还可以在回传 answer 对象的时候，附带下一题题目的下标，在 questionList 中进行跳转。</p>
<h3 id="二、CSS-的作用域"><a href="#二、CSS-的作用域" class="headerlink" title="二、CSS 的作用域"></a>二、CSS 的作用域</h3><p>&emsp;&emsp;vue 项目一般使用单文件组件，组件中的 css 样式作用域以前一直是非常头疼的问题，之前常用的做法一般通过在外层 div 包一个 class 来控制作用域，但是这种做法会莫名地增加工作量，而且写到最后，复杂的 css 后代选择器很难辨别不说还影响性能，所以 vue 里通过“别名”的方式来控制作用域。</p>
<h4 id="1-CSS-作用域"><a href="#1-CSS-作用域" class="headerlink" title="1. CSS 作用域"></a>1. CSS 作用域</h4><p>&emsp;&emsp;当 <code>&lt;style&gt;</code> 标签有 scoped 属性时，它的 CSS 只作用于当前组件中的元素。这类似于 Shadow DOM 中的样式封装。它有一些注意事项，但不需要任何 polyfill。它通过使用 PostCSS 来实现以下转换：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;style scoped&gt;</span><br><span class="line">.example &#123;</span><br><span class="line">  color: red;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;example&quot;&gt;hi&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>
<p>转换结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;style&gt;</span><br><span class="line">.example[data-v-f3f3eg9] &#123;</span><br><span class="line">  color: red;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;example&quot; data-v-f3f3eg9&gt;hi&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>
<h4 id="2-CSS-Modules"><a href="#2-CSS-Modules" class="headerlink" title="2. CSS Modules"></a>2. CSS Modules</h4><p>&emsp;&emsp;CSS Modules 是一个用于模块化和组合 CSS 的流行系统。vue-loader 提供了与 CSS 模块的一流集成，可以作为模拟 CSS 作用域的替代方案。</p>
<h5 id="emsp-emsp-使用"><a href="#emsp-emsp-使用" class="headerlink" title="&emsp;&emsp;使用"></a>&emsp;&emsp;使用</h5><p>&emsp;&emsp;Vue-loader 在 v9.8.0 之后加入了对 CSS Modules 的支持。我们只要在.vue 文件的<code>&lt;style&gt;</code>处加一个 module 就行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;style module&gt;</span><br><span class="line">.red &#123;</span><br><span class="line">  color: red;</span><br><span class="line">&#125;</span><br><span class="line">.bold &#123;</span><br><span class="line">  font-weight: bold;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这将为 css-loader 打开 CSS Modules 模式，生成的 CSS 对象将为组件注入一个名叫 $style 的计算属性，你可以在你的模块中使用动态 class 绑定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;p :class=&quot;$style.red&quot;&gt;</span><br><span class="line">    This should be red</span><br><span class="line">  &lt;/p&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;转换结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;p class=&quot;_1VyoJ-uZOjlOxP7jWUy19_0&quot;&gt;</span><br><span class="line">    This should be red</span><br><span class="line">&lt;/p&gt;</span><br></pre></td></tr></table></figure>
<h5 id="emsp-emsp-支持语法"><a href="#emsp-emsp-支持语法" class="headerlink" title="&emsp;&emsp;支持语法"></a>&emsp;&emsp;支持语法</h5><p>&emsp;&emsp;由于它是一个计算属性，它也适用于 :class 的 object/array 语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p :class=&quot;&#123; [$style.red]: isRed &#125;&quot;&gt;</span><br><span class="line">      Am I red?</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">    &lt;p :class=&quot;[$style.red, $style.bold]&quot;&gt;</span><br><span class="line">      Red and bold</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;你也可以在 JavaScript 访问它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  created () &#123;</span><br><span class="line">    console.log(this.$style.red)</span><br><span class="line">    // -&gt; &quot;_1VyoJ-uZOjlOxP7jWUy19_0&quot;</span><br><span class="line">    // an identifier generated based on filename and className.</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h5 id="emsp-emsp-配置"><a href="#emsp-emsp-配置" class="headerlink" title="&emsp;&emsp;配置"></a>&emsp;&emsp;配置</h5><p>&emsp;&emsp;默认的配置是<code>&#39;[hash:base64]&#39;</code>，即将 class 名转为 hash 值，可读性比较低，不方便调试开发，可以在 Webpack 中对 css-loader 进行配置。针对 vue，在 vue-loader 中配置 cssModules 属性里即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">loader: &apos;vue&apos;,</span><br><span class="line">options: &#123;</span><br><span class="line">    cssModules: &#123;</span><br><span class="line">        // 设置本地别名</span><br><span class="line">        localIdentName: &apos;[name]-[local]-[hash:base64:5]&apos;,</span><br><span class="line">        // 开启驼峰式支持</span><br><span class="line">        camelCase: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;配置后，刚刚的代码转换结果变为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- [组件名]-[class]-[hash] --&gt;</span><br><span class="line">&lt;p class=&quot;App-red-3cl75_0&quot;&gt;</span><br><span class="line">    This should be red</span><br><span class="line">&lt;/p&gt;</span><br></pre></td></tr></table></figure>
<h4 id="3-项目使用"><a href="#3-项目使用" class="headerlink" title="3. 项目使用"></a>3. 项目使用</h4><p>&emsp;&emsp;项目中很多情况下需要对第三方 UI 库中的组件样式做调整，如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"question"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"weui-cells__title"</span>&gt;</span></span><br><span class="line">        test</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    .question &#123;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">    .question .weui-cells__title &#123;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;test 所在的<code>&lt;div&gt;</code>是第三方生产，要修改 test 文字的样式</p>
<h5 id="emsp-emsp-使用-scoped"><a href="#emsp-emsp-使用-scoped" class="headerlink" title="&emsp;&emsp;使用 scoped"></a>&emsp;&emsp;使用 scoped</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;question&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;weui-cells__title&quot;&gt;</span><br><span class="line">        test</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">    .question &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    .question .weui-cells__title &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;转换结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;div data-v-b8a14a32 class=&quot;question&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;weui-cells__title&quot;&gt;</span><br><span class="line">    test</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">    .question[data-v-b8a14a32] &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    .question .weui-cells__title[data-v-b8a14a32] &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;使用这种方式，可能看到转化后的类名并不能匹配到对应的位置，我们期望的类名应该为</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.question</span><span class="selector-attr">[data-v-b8a14a32]</span> <span class="selector-class">.weui-cells__title</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;所以如果要修改第三方的 ui 组件，最好使用 css modules</p>
<h5 id="emsp-emsp-使用-CSS-Modules"><a href="#emsp-emsp-使用-CSS-Modules" class="headerlink" title="&emsp;&emsp;使用 CSS Modules"></a>&emsp;&emsp;使用 CSS Modules</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div :class=&quot;$style.question&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;weui-cells__title&quot;&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style module&gt;</span><br><span class="line">    .question &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    .question :global(.weui-cells__title） &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;转换结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;questionList-question-MErG2_0&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;weui-cells__title&quot;&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">    .questionList-question-MErG2_0 &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    .questionList-question-MErG2_0 .weui-cells__title&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在.vue 文件的<code>&lt;style&gt;</code>处加一个 module，默认将类名转化为局部变量，使用<code>:global(...)</code>来标记全局变量，通过这种方式可以很容易地覆盖原有 UI 组件样式。</p>
<ul>
<li><h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4></li>
<li><a href="https://vue-loader.vuejs.org/zh-cn/features/scoped-css.html" target="_blank" rel="noopener">css 作用域 · vue-loader</a></li>
<li><a href="https://vue-loader.vuejs.org/zh-cn/features/css-modules.html" target="_blank" rel="noopener">css Modules · vue-loader</a></li>
<li><a href="https://segmentfault.com/a/1190000007468604" target="_blank" rel="noopener">在 Vue 工作流中使用 CSS Modules</a></li>
<li><a href="https://github.com/webpack-contrib/css-loader" target="_blank" rel="noopener">css-loader 文档</a></li>
<li><a href="https://github.com/zxc0328/css-modules-demo" target="_blank" rel="noopener">css-modules-demo</a></li>
</ul>
<h3 id="三、IE-兼容"><a href="#三、IE-兼容" class="headerlink" title="三、IE 兼容"></a>三、IE 兼容</h3><p>&emsp;&emsp;因为 IE 不支持 es6 语法，所以如果需要适配 IE 浏览器，需要做特殊的适配处理。vue 使用 webpack 构建项目，可以通过 babel-polyfill 把代码从 es6 转为 es5。</p>
<h4 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[vuex] vuex requires a Promise polyfill in this browser.</span><br></pre></td></tr></table></figure>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev babel-polyfill</span><br></pre></td></tr></table></figure>
<p>在 webpack.config.js 配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    app: [&apos;babel-polyfill&apos;,&apos;./src/main.js&apos;]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="最后的一些想法"><a href="#最后的一些想法" class="headerlink" title="最后的一些想法"></a>最后的一些想法</h2><p>&emsp;&emsp;这次项目使用的框架是 vue，相对于 react，vue 的整体结构化更加清晰一些，很容易写出比较标准的代码，整体的编程风格让人不由自主地超着低耦合的解决方案接近，当然其中也踩了不少的坑，一方面是语法之间的差别需要适应，另一方面就是在有些控件的事件触发顺序上与我想象中的差别很大，经常造成数据显示错误，虽然最后通过 dom 操作强行同步了值，但不是好的解决方案，本次项目中由于某些需求的特殊性，在项目的后期加了很多逻辑比较混乱的代码，如果后面还需要重新使用的话，还需要好好想想重构这些代码。另外题目的可配置性还不够完善，很多地方还是依据当前项目的要求写死，不够通用，这些都是可以改进的地方。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">wxc</p>
              <p class="site-description motion-element" itemprop="description">前端/js/react/vue</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wxc</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.6.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  





  










  





  

  

  

  

  
  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('复制成功')
          else $(this).text('复制失败')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


</body>
</html>
